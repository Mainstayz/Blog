---
layout: post
title: 'é€†å‘é›¶ç¢çŸ¥è¯†ç‚¹'
date: 2017-11-06 00:51:47
tags: []
---
å¦‚é¢˜

<!-- more -->

# ç›¸å…³åè¯

## tweak 

tweak ä¸º å„ç§**ç ´è§£è¡¥ä¸**çš„ç»Ÿç§°ã€‚å¤§è‡´åˆ†ä¸¤ç§ï¼š

1.ï¼ˆè¶Šç‹±ç¯å¢ƒï¼‰ åœ¨cydiaä¸Šå‘å¸ƒçš„ï¼Œéœ€è¦è¶Šç‹±æ‰èƒ½å®‰è£…ï¼Œå¤§éƒ¨åˆ†æ˜¯debæ ¼å¼çš„å®‰è£…åŒ…ã€‚

2. (éè¶Šç‹±ç¯å¢ƒ) å¤§å¤šæ˜¯é’ˆå¯¹æŸä¸ªappï¼Œæ²¡åŠæ³•å†™ç³»ç»Ÿçº§çš„ã€‚

## hook

ocå±Šè‘—åçš„method swizzlingæŠ€æœ¯ï¼Œä»–å°±æ˜¯iOSçš„æ³¨å…¥åŸç†ï¼ˆæ³¨å…¥ä¹Ÿç§°hookï¼‰ã€‚

æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œåœ¨é€†å‘åˆ†æä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ method swizzling å¯ä»¥è·å–åˆ°åŸå‡½æ•°çš„**å‚æ•°ç±»å‹**ï¼Œä»¥åŠ**è¿”å›å€¼**ï¼Œç”šè‡³ **æ³¨å…¥****è‡ªå·±çš„ä»£ç ** ï¼Œä»è€Œè¾¾åˆ°ç›®æ ‡ã€‚

## Mobilesubstrate

iOSåœ¨è¶Šç‹±åï¼Œä¼šé»˜è®¤å®‰è£…ä¸€ä¸ªåå«**mobilesubstrate**çš„åŠ¨æ€åº“ï¼Œå®ƒçš„ä½œç”¨æ˜¯æä¾›ä¸€ä¸ªç³»ç»Ÿçº§çš„å…¥ä¾µç®¡é“ï¼Œæ‰€æœ‰çš„tweakéƒ½å¯ä»¥ä¾èµ–å®ƒæ¥è¿›è¡Œå¼€å‘ã€‚

Mobilesubstrateä¸ºäº†æ–¹ä¾¿tweakå¼€å‘ï¼Œæä¾›äº†ä¸‰ä¸ªé‡è¦çš„æ¨¡å—ï¼š

1. MobileHooker å°±æ˜¯ç”¨æ¥åšä¸Šé¢æ‰€è¯´çš„è¿™ä»¶äº‹çš„ï¼Œå®ƒå®šä¹‰ä¸€ç³»åˆ—çš„å®å’Œå‡½æ•°ï¼Œåº•å±‚è°ƒç”¨objcï¼runtimeå’Œfishhookæ¥æ›¿æ¢ç³»ç»Ÿæˆ–è€…ç›®æ ‡åº”ç”¨çš„å‡½æ•°
2. MobileLoader ç”¨æ¥åœ¨ç›®æ ‡ç¨‹åºå¯åŠ¨æ—¶æ³¨å…¥**ç¬¬ä¸‰æ–¹çš„åŠ¨æ€åº“**ï¼Œç¬¬ä¸‰æ–¹çš„åŠ¨æ€åº“ä¹Ÿå°±æ˜¯æˆ‘ä»¬å†™çš„ç ´è§£ç¨‹åºã€‚ï¼ˆ**æ³¨å…¥åŸç†ç¨åè§£é‡Š**ï¼‰
3. Safe mode ç±»ä¼¼äºwindowsçš„å®‰å…¨æ¨¡å¼ï¼Œæ¯”å¦‚æˆ‘ä»¬å†™çš„ä¸€äº›ç³»ç»Ÿçº§çš„hookä»£ç å‘ç”Ÿcrashæ—¶ï¼Œmobilesubstrateä¼šè‡ªåŠ¨è¿›å…¥å®‰å…¨æ¨¡å¼ï¼Œå®‰å…¨æ¨¡å¼ä¸‹ï¼Œä¼šç¦ç”¨æ‰€æœ‰çš„ç¬¬ä¸‰æ–¹åŠ¨æ€åº“

å¤§æ¦‚äº†è§£æœ‰è¿™ä¹ˆä¸€ä¸ªä¸œè¥¿ã€‚



# æ³¨å…¥åŸç†

**è¿™é‡Œå¾ˆé‡è¦ï¼è¿™é‡Œå¾ˆé‡è¦ï¼è¿™é‡Œå¾ˆé‡è¦ï¼**

è¶Šç‹±ï¼Œä¸éè¶Šç‹±çš„æ³¨å…¥åŸç†æ˜¯ä¸€æ ·çš„ã€‚åœ¨å‡†å¤‡è®²æ³¨å…¥åŸç†ä¹‹å‰ï¼Œè¿˜éœ€è¦ç®€å•äº†è§£ä¸€ä¸‹äºŒè¿›åˆ¶ï¼ˆMach-Oï¼‰æ–‡ä»¶çš„ç»“æ„

> å°±æ˜¯æˆ‘ä»¬åœ¨XcodeæŠŠå·¥ç¨‹buildä¹‹åï¼Œåœ¨Productsæ–‡ä»¶å¤¹é‡Œé¢ä¼šæ‰¾åˆ°xxx.appè¿™ä¸ªåŒ…ï¼Œå³é”®è¿™ä¸ªåŒ…ï¼Œé€‰æ‹©**æ˜¾ç¤ºåŒ…å†…å®¹**å°±èƒ½æ‰¾åˆ°è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶

## Mach-O æ–‡ä»¶ç»“æ„

æˆ‘ä»¬å¹³æ—¶äº†è§£åˆ°çš„åç¼€åä¸º none, .o, .dylib, .bundle éƒ½æ˜¯è¿™ç§æ ¼å¼çš„ã€‚

Mach-O çš„ç»„æˆç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºåŒ…æ‹¬äº†Headerã€Load commandsã€Dataã€‚

![](https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1509989193040&di=ef217aba5bd89b25a8f7bf2d0887095d&imgtype=0&src=http%3A%2F%2Fupload-images.jianshu.io%2Fupload_images%2F1743782-dc4d007313f0118a.jpg%3FimageMogr2%2Fauto-orient%2Fstrip%257CimageView2%2F2%2Fw%2F1240)

### é—®é¢˜1:Mach-Oæ–‡ä»¶å¦‚ä½•æ³¨å…¥ç¬¬ä¸‰æ–¹åŠ¨æ€åº“å‘¢ï¼Ÿ

äºŒè¿›åˆ¶æ–‡ä»¶å½“ä¸­æ‰€æœ‰å¼•ç”¨åˆ°çš„åŠ¨æ€åº“éƒ½æ”¾åœ¨**Load commands**æ®µå½“ä¸­ï¼Œæ‰€ä»¥ï¼Œ**é€šè¿‡ç»™è¿™ä¸ªæ®µå¢åŠ è®°å½•ï¼Œå°±å¯ä»¥æ³¨å…¥æˆ‘ä»¬è‡ªå·±å†™çš„åŠ¨æ€åº“äº†**

ä¾‹å­ï¼š

![](/images/1564383821454.jpg)

- è“è‰²æ¡†å†…çš„å°±æ˜¯AppåŸæ¥é“¾æ¥çš„åŠ¨æ€åº“ï¼ˆå¯ä»¥çœ‹åˆ°å¾ˆç†Ÿæ‚‰çš„å­—çœ¼ SDWebImageï¼ŒSVProgressHUDï¼ŒiCarouselç­‰ç­‰ï¼‰
- çº¢è‰²æ¡†å†…çš„å°±æ˜¯æˆ‘æ³¨å…¥çš„åŠ¨æ€åº“ï¼Œçº¢è‰²ç®­å¤´æŒ‡å‘çš„é‚£ä¸ªå°±æ˜¯åŠ¨æ€åº“æ‰€åœ¨çš„ä½ç½® **@executable_path/Frameworks/libJFjingrongDylb.dylib**ã€‚ï¼ˆæˆ‘æŠŠè¿™ä¸ªåŠ¨æ€åº“æ‹·è´åˆ°ä½ çš„AppåŒ…é‡Œé¢Frameworksæ–‡ä»¶å¤¹ï¼‰

**è¿™æ ·ä¸€æ¥ï¼Œä½ çš„Appå¯åŠ¨çš„æ—¶å€™å°±é€šè¿‡ Load commands åŠ è½½æˆ‘å†™çš„åŠ¨æ€åº“ã€‚**

### é—®é¢˜2:æ’å…¥æˆ‘ä»¬è‡ªå·±çš„åŠ¨æ€åº“åï¼Œå¦‚ä½•æ‰§è¡Œå…¶ä¸­çš„ä»£ç ï¼Ÿ

å…¶ä»–åŠ¨æ€åº“ï¼Œæ¯”å¦‚SDWebImageè¿™ä¸ªï¼Œè‚¯å®šåœ¨æœ‰ä»£ç å¼•ç”¨SDWebImageè¿™ä¸ªåº“ï¼Œè°ƒç”¨äº†ç›¸å…³æ–¹æ³•ï¼Œæ‰€ä»¥è¿™ä¸ªåŠ¨æ€åº“é‡Œé¢ä»£ç æ‰æœ‰æœºä¼šæ‰§è¡Œã€‚

é‚£æˆ‘ä»¬æ’å…¥è‡ªå·±çš„åŠ¨æ€åº“åï¼Œåˆ«äººçš„Appä¸­çš„ä»£ç ï¼Œè‚¯å®šæ²¡æœ‰æˆ‘ä»¬åŠ¨æ€åº“æ‰§è¡Œçš„å…¥å£ã€‚

å› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ª"main"å‡½æ•°æ¥æ‰§è¡Œæˆ‘ä»¬è‡ªå·±çš„ä»£ç ï¼Œocé‡Œé¢ç§°ä¸ºæ„é€ å‡½æ•°ï¼Œåªè¦åœ¨å‡½æ•°å‰å£°æ˜ **â€œattribute((constructor)) staticâ€** å³å¯ã€‚

```
__attribute__((constructor)) static void entry(){
    NSLog(@"insert dylib success ğŸ‘ğŸ‘");
    
}

```

æŠŠä»¥ä¸Šä»£ç æ”¾ç½®æˆ‘ä»¬åŠ¨æ€åº“ä¸­å°±å¥½äº†

### å°å°æ€»ç»“ä¸€ä¸‹

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬åº”è¯¥äº†è§£æ³¨å…¥çš„åŸç†äº†ã€‚ï¼ˆæ²¡äº†è§£ï¼Œåˆ«å¾€ä¸‹çœ‹äº†ï¼‰

æ­¥éª¤å¦‚ä¸‹ï¼š

1. å¾€Mach-Oæ–‡ä»¶ä¸­çš„LoadCommandsæ®µæ·»åŠ ç¬¬ä¸‰åº“è®°å½•ï¼Œå¹¶å°†å…¶è·¯å¾„æŒ‡å‘ç¬¬ä¸‰åº“æ‰€åœ¨çš„ä½ç½®ä¸­ã€‚
2. ç¬¬ä¸‰åº“æ·»åŠ æ„é€ å‡½æ•°ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬çš„ä»£ç å°±æœ‰æœºä¼šè¿è¡Œäº†ï¼



# è¶Šç‹±ç¯å¢ƒä¸éè¶Šç‹±ç¯å¢ƒæ³¨å…¥åŒºåˆ«ï¼ˆå¯é€‰ï¼Œäº†è§£å°±å¥½ï¼‰

## è¶Šç‹±ç¯å¢ƒä¸‹ï¼š

è¿˜è®°å¾—ä¹‹å‰æè¿‡çš„**mobilesubstrate**å—ï¼Ÿ

MobileLoader **å…ˆäº**ç¨‹åºåŠ è½½ç¬¬ä¸‰æ–¹åº“æ—¶**è¢«æ³¨å…¥**ï¼Œä¹‹åæŸ¥æ‰¾è¶Šç‹±æ‰‹æœº/Library/MobileSubstrate/DynamicLibraries/ç›®å½•ä¸‹åŠ¨æ€åº“ï¼Œæ ¹æ®é…ç½®æ–‡ä»¶ï¼ˆFilter plistï¼‰ï¼ŒæŒ‰éœ€åŠ è½½åŒ¹é…çš„åŠ¨æ€åº“ã€‚

é€šä¿—ç‚¹è®²ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡cydiaä¸‹å®‰è£…åˆ°åŠ¨æ€åº“æˆ–è€…è‡ªå·²ç¼–å†™åŠ¨æ€åº“ï¼ˆç»Ÿç§°tweakï¼Œç ´è§£è¡¥ä¸ï¼‰å¤åˆ¶åˆ°è¶Šç‹±æ‰‹æœº/Library/MobileSubstrate/DynamicLibraries/ç›®å½•ä¸‹ï¼ŒMobileLoaderä¼šåœ¨ç›¸å…³Appå¯åŠ¨å‰è¢«æ³¨å…¥ï¼ŒæŒ‰éœ€åŠ è½½åŠ¨æ€åº“ã€‚

## éè¶Šç‹±ç¯å¢ƒä¸‹ï¼š

1. é€šè¿‡é€†å‘å·¥å…·theosï¼ŒiOSOpenDevï¼ŒMonkeyDev ç­‰ï¼Œ**ç¼–å†™åŠ¨æ€åº“**ã€‚
2. ç„¶å**å¤åˆ¶åˆ°iPAå®‰è£…åŒ…å†…**
3. **ä¿®æ”¹ LoadCommands**ï¼ŒåŠ è½½åŠ¨æ€åº“
4. **é‡æ‰“åŒ…ç­¾å**

ä¸Šé¢çš„è¿™ä¸ªåˆ—å­å°±æ˜¯é€šè¿‡è¿™å››ä¸ªæ­¥éª¤æ¥å®ç°æ³¨å…¥çš„ã€‚

# é€†å‘åˆ†æè¿‡ç¨‹

## ç ¸å£³

1. ä»appstoreä¸‹è½½çš„appäºŒè¿›åˆ¶éƒ½æ˜¯ç»è¿‡åŠ å¯†çš„ï¼Œæˆ‘ä»¬è¦classdumpï¼ˆå¯¼å‡ºå¤´æ–‡ä»¶ï¼‰æ˜¯éœ€è¦ç ¸å£³çš„ã€‚
2. å…¶æ¬¡åæ±‡ç¼–åˆ†æä¹Ÿæ˜¯éœ€è¦ä¸€ä¸ªå·²ç»ç ¸å£³çš„çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

è¶Šç‹±æƒ…å†µä¸‹ï¼Œå¯é€šè¿‡sshåˆ°æ‰‹æœºç»ˆç«¯ï¼Œé€šè¿‡**Cluth**å·¥å…·ï¼Œåœ¨æ‰‹æœºå†…è¿›è¡Œç ¸å£³ï¼Œç„¶åcopyåˆ°æ¡Œé¢è¿›è¡Œ

## åˆ†æ

### ç½‘ç»œåˆ†æ

é€šè¿‡åˆ†æå’Œç¯¡æ”¹æ¥å£æ•°æ®ï¼Œå¯ä»¥æœ‰æ•ˆçš„ç ´è§£é€šè¿‡æ¥å£æ•°æ®æ¥æ§åˆ¶å®¢æˆ·ç«¯è¡Œä¸ºçš„appï¼Œå¸¸ç”¨çš„æŠ“åŒ…å·¥å…·æœ‰Charles, WireSharkç­‰ï¼Œwindowså¹³å°æœ‰fidller

### é™æ€åˆ†æ

è¿™é‡Œå°±å‰å®³äº†ï¼Œåæ±‡ç¼–ã€classdumpå¤´æ–‡ä»¶ç­‰æŠ€æœ¯æ¥åˆ†æappè¡Œä¸ºï¼Œåæ±‡ç¼–å·¥å…·æœ‰hopperï¼ŒiDAã€‚

![](/images/1564383842489.jpg)

![](/images/1564383855704.jpg)

### åŠ¨æ€åˆ†æ

åŠ¨æ€åˆ†ææŒ‡çš„æ˜¯é€šè¿‡åˆ†æappçš„è¿è¡Œæ—¶æ•°æ®ï¼Œæ¥å®šä½æ³¨å…¥ç‚¹æˆ–è€…è·å–å…³é”®æ•°æ®

> æœ‰æ—¶ï¼ŒæŠ“ä¸åˆ°åŒ…ï¼Œæˆ‘å°±hookç½‘ç»œè¯·æ±‚æ–¹æ³•ï¼Œä¸¾ä¸ªä¾‹å­ï¼ŒRNå†™çš„ä»£ç ï¼Œå¯ä»¥å°è¯•hook-[RCTNetworking decodeTextData:fromResponse:withCarryData:]å°±èƒ½æ‰€æœ‰çš„ç½‘ç»œè¯·æ±‚æ•°æ®

å¸¸ç”¨çš„å·¥å…·æœ‰

1. cycriptï¼ˆè¿è¡Œæ—¶æ§åˆ¶å°ï¼‰
2. lldbï¼ˆæ–­ç‚¹è°ƒè¯•ï¼‰
3. frida (è‡ªå®šä¹‰JavaScriptä»£ç æ³¨å…¥ç¬¬ä¸‰æ–¹App)
4. Xcode æ˜¾ç¤ºè§†å›¾å±‚çº§

## æœ€åç¼–å†™åŠ¨æ€åº“æ³¨å…¥



# å®‰å…¨åŠ å›ºé˜²æŠ¤

## ä»»åŠ¡ç®¡ç†å™¨ä¸­å±å¹•æˆªå›¾æ•æ„Ÿä¿¡æ¯çš„ä¿æŠ¤

å› æ­¤å½“åº”ç”¨ç¨‹åºè¿›å…¥åå°æ—¶ï¼Œç³»ç»Ÿä¼šä¿å­˜Appçš„å±å¹•æˆªå›¾ã€‚
![](/images/1564383864755.png)

Xcode9ä¸­ï¼Œè¿™ä¸ªæˆªå›¾è·¯å¾„å¦‚ä¸‹ï¼š

æ¨¡æ‹Ÿå™¨ï¼š

/Users/<ä½ çš„ç”¨æˆ·å>/Library/Developer/CoreSimulator/Devices/<æ¨¡æ‹Ÿå™¨çš„ç¼–å·>/data/Containers/Data/Application/<APPçš„GUID>/Library/Caches/Snapshots/
.ktx ç»“å°¾çš„å›¾ç‰‡ä¿¡æ¯

çœŸæœºæœªæµ‹è¯•ã€‚ã€‚

å¦‚ä½•ä¿æŠ¤å‘¢ï¼Ÿåœ¨**applicationDidEnterBackground**ä¸­ï¼Œå®ç°ç±»æ˜¯å¦‚ä¸‹ä»£ç å°±å¥½äº†

```
- (void)applicationDidEnterBackground:(UIApplication *)application {
    UIImageView *bgImg = [[UIImageView alloc] initWithImage:[UIImage imageNamed:@"mac_dog"]];
    [self.window addSubview: bgImg];
}
****
```

## é™æ€åˆ†æä¿æŠ¤

### ä»£ç æ··æ·†

1. å­—ç¬¦ä¸²åŠ å¯†ã€‚åœ¨é€†å‘ä¸­ï¼Œç§é’¥ï¼ŒåŠ å¯†æ–¹å¼ï¼Œç½‘ç»œæ¥å£ç­‰ç­‰æ•æ„Ÿä¿¡æ¯ï¼Œæ˜æ–‡å­—ç¬¦ä¸²æä¾›å¸®åŠ©å®åœ¨å¤ªå¤§äº†ã€‚åº”è¯¥åœ¨æ•æ„Ÿçš„åœ°æ–¹ï¼Œå¯¹äºè¦ä½¿ç”¨åˆ°çš„å­—ç¬¦ä¸²ï¼Œå…ˆä¿å­˜åŠ å¯†åçš„æ•°æ®ï¼Œä½¿ç”¨çš„æ—¶å€™ï¼Œæ’å…¥è§£å¯†ç®—æ³•ã€‚å¯¹äºè§£å¯†ç®—æ³•ï¼Œåº”è¯¥ä½¿ç”¨[static inline](http://www.blogfshare.com/ioss-static-inline.html)æ–¹å¼ç¼–è¯‘ã€‚inlineç¼–è¯‘ï¼šä¼šæŠŠè¯¥å‡½æ•°çš„ä»£ç æ‹·è´åˆ°æ¯æ¬¡è°ƒç”¨è¯¥å‡½æ•°çš„åœ°æ–¹ã€‚staticç¼–è¯‘ä¼šè®©ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ²¡æœ‰æ¸…æ™°çš„ç¬¦å·è¡¨ã€‚ 
2. ç±»åæ–¹æ³•åæ··æ·†ã€‚å¯¹äºç¨‹åºä¸­çš„ç±»åæ–¹æ³•åï¼Œè‡ªå·±äº§ç”Ÿä¸€ä¸ªéšæœºçš„å­—ç¬¦ä¸²æ¥æ›¿æ¢è¿™äº›å®šä¹‰çš„ç±»åå’Œæ–¹æ³•åï¼Œä½†æ˜¯ä¸æ˜¯æ‰€æœ‰ç±»åï¼Œæ–¹æ³•åéƒ½èƒ½æ›¿æ¢çš„ï¼Œè¦è¿‡æ»¤åˆ°ç³»ç»Ÿæœ‰å…³çš„å‡½æ•°ä»¥åŠç±»ã€‚æ–¹æ³•å¾ˆå¤šã€‚
3. ç¨‹åºä»£ç æ··æ·†ã€‚è¿™ä¸ªå°±å¤æ‚äº†ï¼Œå¯ä»¥åŸºäºXcodeä½¿ç”¨çš„ç¼–è¯‘å™¨clangï¼Œç„¶ååœ¨ä¸­é—´å±‚ä¹Ÿå°±æ˜¯**IR**å®ç°è‡ªå·±çš„ä¸€äº›æ··æ·†å¤„ç†ï¼Œæ¯”å¦‚åŠ å…¥ä¸€äº›æ— ç”¨çš„é€»è¾‘å—å•Šï¼Œä»£ç å—å•Šï¼Œä»¥åŠåŠ å…¥å„ç§è·³è½¬ä½†æ˜¯åˆä¸å½±å“ç¨‹åºåŸæœ‰çš„é€»è¾‘ã€‚ä¼°è®¡å¾—åŠ¨å¤§åˆ€å­ã€‚[é“¾æ¥ï¼Œå¤§æ¦‚äº†è§£æœ‰è¿™ä¹ˆä¸€å›äº‹å°±å¥½](https://bbs.pediy.com/thread-211717.htm)

### æ•æ„Ÿé€»è¾‘çš„ä¿æŠ¤

æŠŠå‡½æ•°åéšè—åœ¨ç»“æ„ä½“é‡Œï¼Œä»¥å‡½æ•°æŒ‡é’ˆæˆå‘˜çš„å½¢å¼å­˜å‚¨ã€‚
è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œç¼–è¯‘åï¼Œåªç•™äº†ä¸‹åœ°å€ï¼Œå»æ‰äº†åå­—å’Œå‚æ•°è¡¨ï¼Œæé«˜äº†é€†å‘æˆæœ¬å’Œæ”»å‡»é—¨æ§›ã€‚

æ¯”å¦‚æœ‰å¦‚ä¸‹ä¸€ä¸ªç±»

```
@interface XXUtil : NSObject  
  
+ (BOOL)isVerified;  
+ (BOOL)isNeedSomething;  
+ (void)resetPassword:(NSString *)password;  
  
@end 
```

æ”¹å†™ä¹‹å

```
#import <Foundation/Foundation.h>  
  
typedef struct _util {  
    BOOL (*isVerified)(void);  
    BOOL (*isNeedSomething)(void);  
    void (*resetPassword)(NSString *password);  
}XXUtil_t ;  
  
#define XXUtil ([_XXUtil sharedUtil])  
  
@interface _XXUtil : NSObject  
  
+ (XXUtil_t *)sharedUtil;  
@end  

```

```
//XXUtil.m  
#import "XXUtil.h"  
  
static BOOL _isVerified(void)  
{  
    //bala bala ...  
    return YES;  
}  
  
static BOOL _isNeedSomething(void)  
{  
    //bala bala ...  
    return YES;  
}  
  
static void _resetPassword(NSString *password)  
{  
    //bala bala ...  
}  
  
static XXUtil_t * util = NULL;  
@implementation _XXUtil  
  
+(XXUtil_t *)sharedUtil  
{  
    static dispatch_once_t onceToken;  
    dispatch_once(&onceToken, ^{  
        util = malloc(sizeof(XXUtil_t));  
        util->isVerified = _isVerified;  
        util->isNeedSomething = _isNeedSomething;  
        util->resetPassword = _resetPassword;  
    });  
    return util;  
}  
  
+ (void)destroy  
{  
    util ? free(util): 0;  
    util = NULL;  
}  
@end 

```

### ç¬¦å·è¡¨å‰¥ç¦»

ä¸è¦ä¸Šä¼ .dSYMç¬¦å·è¡¨å°±å¥½äº†ï¼ˆé»˜è®¤å°±æ˜¯è¿™æ ·ï¼‰ï¼Œä¸è¿‡ä¾æ—§å¯ä»¥é€šè¿‡äºŒè¿›åˆ¶æ–‡ä»¶è¿˜åŸå‡ºæ¥ï¼Œæ‰€ä»¥è¿˜æ˜¯åšä»£ç æ··æ·†çš„å¥½ã€‚

### äºŒè¿›åˆ¶æ–‡ä»¶æœ‰æ•ˆæ€§æ£€æŸ¥

å°¤å…¶æ˜¯å’Œé’±æœ‰å…³ç³»çš„appï¼Œæˆ‘ä»¬æœ‰å¿…è¦åœ¨å’ŒæœåŠ¡å™¨é€šä¿¡æ—¶ï¼Œè®©æœåŠ¡å™¨çŸ¥é“å®¢æˆ·ç«¯åˆ°åº•æ˜¯ä¸æ˜¯å®˜æ–¹æ­£ç‰ˆçš„appã€‚

ä½•ä»¥åˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯æ­£ç‰ˆappå‘¢ï¼Ÿæ— éå°±2ä¸ªåœ°æ–¹å¯ä»¥åŠ¨ï¼Œ1ä¸ªæ˜¯äºŒè¿›åˆ¶ï¼Œ1ä¸ªæ˜¯èµ„æºæ–‡ä»¶ã€‚

åœ¨æ²™ç›’ä¸­ï¼Œå¯ä»¥è¯»åˆ°è‡ªå·±ç¨‹åºçš„äºŒè¿›åˆ¶ï¼Œä¹Ÿå¯ä»¥è¯»åˆ°èµ„æºæ–‡ä»¶ç­¾åæ–‡ä»¶ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶éƒ½ä¸ç®—å¤§ï¼Œå¯ä»¥å¯¹å…¶å–md5å€¼ç„¶åä»¥æŸç§ç»„åˆç®—æ³•å¾—åˆ°ä¸€ä¸ªæ ‡è®°å­—ç¬¦ä¸²ï¼Œç„¶åå‘ç»™æœåŠ¡å™¨ã€‚æœåŠ¡å™¨æ£€æµ‹åˆ°å¼‚å¸¸å°±åœæ­¢å“åº”ã€‚

## åŠ¨æ€åˆ†æä¿æŠ¤

### hookï¼Œæ³¨å…¥çš„é˜²æŠ¤æ£€æµ‹

hookï¼Œæ³¨å…¥çš„åŸç†åœ¨è¿™é‡Œå°±ä¸è¯¦ç»†è¯´äº†ï¼Œå› ä¸ºä¸Šé¢å·²ç»è§£é‡Šäº†ã€‚

æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥æ£€æµ‹å‡ºAppæ˜¯å¦è¢«æ³¨å…¥ç¬¬ä¸‰æ–¹åº“ï¼Œæˆ–è€…å‡½æ•°æ˜¯å¦hookã€‚

#### åˆ¤æ–­æ˜¯å¦è¢«ç¬¬ä¸‰æ–¹åº“æ³¨å…¥

æ–¹æ³•_dyld_get_image_name() å¯ä»¥è·å–åŠ¨æ€åº“è·¯å¾„
æ–¹æ³•_dyld_image_count() å¯ä»¥è·å–åŠ¨æ€åº“çš„æ€»æ•°

æ¯”å¦‚ä¸€ä¸‹ä»£ç å°±æ˜¯æ£€æŸ¥æ˜¯å¦è¶Šç‹±ï¼š

```
    uint32_t count = _dyld_image_count();     
    char *substrate = "/Library/MobileSubstrate/MobileSubstrate.dylib";  // è¶Šç‹±å°±ä¼šå®‰è£… MobileSubstrate
    for(uint32_t i = 0; i < count; i++) {
        const char *dyld = _dyld_get_image_name(i); 
        if (strcmp(dyld,substrate)==0) {
            NSLog(@"è¢«è¶Šç‹±äº†"); 
        }     
    }
     
```

#### é˜²æ­¢ç¬¬ä¸‰æ–¹åº“çš„æ³¨å…¥

**é‡ç‚¹ï¼šç¬¬ä¸‰æ–¹åº“çš„æ³¨å…¥ï¼Œä¼šä½¿ç”¨åˆ°ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼šDYLD_INSERT_LIBRARIESï¼ï¼**


æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥å¿½ç•¥ç¯å¢ƒå˜é‡ï¼Œç¼–è¯‘çš„æ—¶å€™ç»™äºŒè¿›åˆ¶æ–‡ä»¶æ–°å¢ä¸€ä¸ªåä¸ºâ€œ__RESTRICTâ€çš„sectionã€‚

åœ¨XCodeçš„Other Linker Flagsâ€æ·»åŠ å¦‚ä¸‹æ ‡è®°ï¼š

```
-Wl,-sectcreate,__RESTRICT,__restrict,/dev/null 
```





#### åˆ¤æ–­æ–¹æ³•æ˜¯å¦è¢«hook

ä½¿ç”¨**dladdr**æ–¹æ³•å¯ä»¥è·å¾—ä¸€ä¸ªå‡½æ•°æ‰€åœ¨æ¨¡å—ï¼Œåç§°ä»¥åŠåœ°å€ã€‚å¸¸ç”¨äºæ•æ„Ÿæ–¹æ³•çš„æ£€æµ‹ï¼Œæ¯”å¦‚è¯´è¿…é›·æœ€ç»å…¸çš„isVip...

```
 #include <dlfcn.h>
 #include <objc/objc.h>
 #include <objc/runtime.h>
 #include <stdio.h>
 #include <string.h>
 #import <Foundation/Foundation.h>
 #import "ClassA.h"

int main(int argc, const char * argv[]) {
    Dl_info info;
    
    IMP imp = class_getMethodImplementation(objc_getClass("NSArray"),sel_registerName("description"));

    if (dladdr(imp, &info)) {
        printf("dli_fname: %s\n", info.dli_fname);
        printf("dli_sname: %s\n", info.dli_sname);
    }
    
    Method origMethod = class_getInstanceMethod(objc_getClass("NSArray"), @selector(description));
    Method swizzleMethod = class_getInstanceMethod(objc_getClass("ClassA"), @selector(fun));
    method_exchangeImplementations(origMethod, swizzleMethod);
    
    IMP new = class_getMethodImplementation(objc_getClass("NSArray"),sel_registerName("description"));
    
    
    if (dladdr(new, &info)) {
        printf("dli_fname: %s\n", info.dli_fname);
        printf("dli_sname: %s\n", info.dli_sname);
    }
    

}


```

è¾“å…¥å¦‚ä¸‹ï¼š

```
dli_fname: /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation
dli_sname: -[NSArray description]
dli_fname: /Users/pillar/Library/Developer/Xcode/DerivedData/dladdr-cxmvfesftyysyoeeebrctvatxmkq/Build/Products/Debug/dladdr
dli_sname: -[ClassA fun]
Program ended with exit code: 0

```

## åè°ƒè¯•

æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥æ£€æµ‹è°ƒè¯•å™¨æ˜¯å¦è¿æ¥åˆ°åº”ç”¨ç¨‹åº

### ptrace

ptraceæ˜¯ä¸€ä¸ªsyscallï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œå®ƒæä¾›ä¸€ä¸ªæœºåˆ¶ä½¿çˆ¶è¿›ç¨‹å¯ä»¥è§‚å¯Ÿæ§åˆ¶å…¶ä»–è¿›ç¨‹ã€‚åŒæ—¶ptraceè¿˜æä¾›äº†ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å‚æ•°é‚£å°±æ˜¯**PT_DENY_ATTACH**ï¼Œè¿™ä¸ªå‚æ•°ç”¨æ¥å‘Šè¯‰ç³»ç»Ÿï¼Œé˜»æ­¢è°ƒè¯•å™¨ä¾é™„ã€‚

æ‰€ä»¥æœ€å¸¸ç”¨çš„åè°ƒè¯•æ–¹æ¡ˆå°±æ˜¯é€šè¿‡è°ƒç”¨ptraceæ¥å®ç°åè°ƒè¯•ã€‚

iOSå¹³å°ä¸Šçš„ptraceå‡½æ•°æ˜¯ä¸å¯ç”¨çš„ï¼Œä¸‹é¢çš„ä»£ç å¯ä»¥ç”¨æ¥é‡æ–°å®ç°çš„åŠŸèƒ½ï¼š

```
// å®šä¹‰å‡½æ•°æŒ‡é’ˆ
typedef int (*ptrace_ptr_t)(int _request, pid_t _pid, caddr_t _addr, int _data); 

// PT_DENY_ATTACH è¿™ä¸ªå°±æ˜¯é˜»æ­¢è°ƒè¯•å™¨ä¾é™„çš„æ ‡ç¤ºï¼Œç­‰äº31
#if !defined(PT_DENY_ATTACH) 
    #define PT_DENY_ATTACH 31 
#endif 

//RTLD_NOW è¿”å›å‰ï¼Œè§£æå‡ºæ‰€æœ‰æœªå®šä¹‰ç¬¦å·
//RTLD_GLOBAL åŠ¨æ€åº“ä¸­å®šä¹‰çš„ç¬¦å·å¯è¢«å…¶åæ‰“å¼€çš„å…¶å®ƒåº“è§£æ

//ä»¥æŒ‡å®šæ¨¡å¼æ‰“å¼€æŒ‡å®šçš„åŠ¨æ€è¿æ¥åº“æ–‡ä»¶ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¥æŸ„ç»™è°ƒç”¨è¿›ç¨‹
void* handle = dlopen(0, RTLD_GLOBAL | RTLD_NOW); 

//æ ¹æ®åŠ¨æ€é“¾æ¥åº“æ“ä½œå¥æŸ„(handle)ä¸ç¬¦å·("ptrace"),è¿”å›ç¬¦å·å¯¹åº”çš„åœ°å€
ptrace_ptr_t ptrace_ptr = dlsym(handle, "ptrace");

// é˜»æ­¢ä¾é™„ 
ptrace_ptr(PT_DENY_ATTACH, 0, 0, 0); 

// å…³é—­å¥æŸ„
dlclose(handle);
 
```

### sysctl

å½“ä¸€ä¸ªè¿›ç¨‹è¢«è°ƒè¯•çš„æ—¶å€™ï¼Œè¯¥è¿›ç¨‹ä¼šæœ‰ä¸€ä¸ªæ ‡è®°æ¥æ ‡è®°è‡ªå·±æ­£åœ¨è¢«è°ƒè¯•ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡sysctlå»æŸ¥çœ‹å½“å‰è¿›ç¨‹çš„ä¿¡æ¯ï¼Œçœ‹æœ‰æ²¡æœ‰è¿™ä¸ªæ ‡è®°ä½å³å¯æ£€æŸ¥å½“å‰è°ƒè¯•çŠ¶æ€ã€‚

ä¸‹é¢ä»£ç æ¥æºäºï¼š
https://developer.apple.com/library/content/qa/qa1361/_index.html

```
#include <assert.h>
#include <stdbool.h>
#include <sys/types.h>
#include <unistd.h>
#include <sys/sysctl.h>
#include <sys/proc.h>


static bool AmIBeingDebugged(void)
    // Returns true if the current process is being debugged (either 
    // running under the debugger or has a debugger attached post facto).
{
    int                 junk;
    int                 mib[4];
    struct kinfo_proc   info;
    size_t              size;

    // Initialize the flags so that, if sysctl fails for some bizarre 
    // reason, we get a predictable result.

    info.kp_proc.p_flag = 0;

    // Initialize mib, which tells sysctl the info we want, in this case
    // we're looking for information about a specific process ID.

    mib[0] = CTL_KERN;
    mib[1] = KERN_PROC;
    mib[2] = KERN_PROC_PID;
    mib[3] = getpid();

    // Call sysctl.

    size = sizeof(info);
    junk = sysctl(mib, sizeof(mib) / sizeof(*mib), &info, &size, NULL, 0);
    assert(junk == 0);

    // We're being debugged if the P_TRACED flag is set.

    return ( (info.kp_proc.p_flag & P_TRACED) != 0 );
}
```

P_TRACED åœ¨<sys/proc.h>å†…ï¼Œè¡¨ç¤ºè°ƒè¯•å™¨è¢«ä¾é™„

```
#define	P_TRACED	0x00000800	/* Debugged process being traced */
```

### syscall

ä¸ºä»å®ç°ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œç³»ç»Ÿæä¾›äº†ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°syscallï¼Œä¸Šé¢è®²åˆ°çš„ptraceä¹Ÿæ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨å»å®ç°çš„ã€‚

æ‰€ä»¥å¦‚ä¸‹çš„è°ƒç”¨ç­‰åŒäºè°ƒç”¨ptrace:

```
syscall(26,31,0,0);
```

