---
layout: post
title: 'æƒ…äººèŠ‚çš„ç¤¼ç‰©ï¼Œé€†å‘å¾®ä¿¡å®ç°æ˜¾ç¤ºå¥½å‹æ¶ˆæ¯å‘é€çš„æ—¶é—´é—´éš”ï¼Œäº†è§£taåœ¨ä¹ä½ '
date: 2017-08-27 22:38:20
tags: []
---

## é¡¹ç›®åœ°å€ï¼š

[https://github.com/Mainstayz/WeChatMsgInterval ](https://github.com/Mainstayz/WeChatMsgInterval)

ä¸å®šæœŸæ›´æ–°ã€‚

ä¸€èˆ¬æ¥è¯´ä¸€ä¸ªäººå–œæ¬¢ä½ çš„ç¨‹åº¦å’Œtaå›ä½ çŸ­ä¿¡æ¶ˆæ¯çš„é€Ÿåº¦ä¸€èˆ¬æˆæ­£æ¯”ã€‚å¦‚æœä½ çš„å¦ä¸€åŠå›ä½ æ¶ˆæ¯è¶Šæ¥è¶Šæ…¢ï¼Œé‚£ä¹ˆ.....è¿™åªæ˜¯ä¸€å¼ ä¾‹å­å›¾ï¼Œæˆ‘å¯ä¸æåŸºã€‚

é—²è¯å°‘è¯´ï¼Œå“ˆå“ˆï¼Œå’±ä»¬è¿›å…¥æ­£é¢˜ï¼Œä¸€æ­¥ä¸€æ­¥çš„åšå‡ºè¿™ä¹ˆåŠŸèƒ½ï¼Œè¿™é‡Œç€é‡åˆ†æè¿‡ç¨‹ã€‚

<!--more-->

å…ˆç»™å¤§ä¼™çœ‹çœ‹æ•ˆæœå›¾ï¼š

![](/images/1564382921055.jpg)

## åˆ†æ

è£…å¥½ä»¥ä¸‹å·¥å…·ï¼š

- [MonkeyDev](https://github.com/AloneMonkey/MonkeyDev/wiki/%E5%AE%89%E8%A3%85) 
- hopper
- [Cycript](http://www.cycript.org/)
- LLDBï¼ˆXcodeï¼‰
- [theos](https://github.com/theos/theos/wiki/Installation)

éå¸¸æ„Ÿè°¢MonkeyDevçš„ä½œè€…å¼€å‘å‡ºçš„è¿™ä¹ˆä¸€æ¬¾å·¥å…·ã€‚

### 1. æ‰¾åˆ°èŠå¤©ç•Œé¢æ•°æ®æºï¼Œåœ¨Cellçš„æ•°æ®æ¨¡å‹ä¸Šæ·»åŠ ç”¨äºæ˜¾ç¤ºæ¶ˆæ¯å‘é€é—´éš”NSStringå±æ€§ã€‚

#### 1.1 æ‰¾å‡ºèŠå¤©ç•Œé¢çš„æ•°æ®æº

é¦–å…ˆæ‰¾åˆ°å½“å‰èŠå¤©æ§åˆ¶å™¨ï¼Œç¥­å‡º**cycript**ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤

```
[[[UIWindow keyWindow] rootViewController] _printHierarchy].toString()
```

> å½“ç„¶LLDBä¸­ä¹Ÿå¯ä»¥
> expr @import UIKit
> po [[[UIWindow keyWindow] rootViewController] _printHierarchy]
> æ ¼å¼éƒ½å¯¹é½æ•´ç†å¥½äº†ï¼Œæ¨è

æ‰“å°å‡ºæ‰€æœ‰çš„UIViewControllerï¼Œä»¥åŠå…¶viewçš„çŠ¶æ€

```
cy# [[[UIWindow keyWindow] rootViewController] _printHierarchy].toString()
"<MMTabBarController 0x10a097800>, state: appeared, view: <UILayoutContainerView 0x10accb920>
| <MMUINavigationController 0x10a062c00>, state: appeared, view: <UILayoutContainerView 0x10b54c900>
|    | <NewMainFrameViewController 0x1098e9a00>, state: disappeared, view: <MMUIHookView 0x10ab014f0> not in the window
|    | <BaseMsgContentViewController 0x109b86c00>, state: appeared, view: <UIView 0x1122f9060>
| <MMUINavigationController 0x10993e600>, state: disappeared, view: <UILayoutContainerView 0x10b5631e0> not in the window
|    | <ContactsViewController 0x109938800>, state: disappeared, view:  (view not loaded)
| <MMUINavigationController 0x10a089e00>, state: disappeared, view: <UILayoutContainerView 0x10acb70c0> not in the window
|    | <FindFriendEntryViewController 0x10a089800>, state: disappeared, view:  (view not loaded)   
| <MMUINavigationController 0x10a09bc00>, state: disappeared, view: <UILayoutContainerView 0x10acc5160> not in the window
|    | <MoreViewController 0x10a08e600>, state: disappeared, view:  (view not loaded)"

```

çœ‹åˆ°è¿™é‡Œï¼ŒiOSå¼€å‘è€å¸æœºå¤§æ¦‚å°±çŸ¥é“äº†ï¼Œé¡¶å±‚æ˜¯ä¸€ä¸ª**MMTabBarController**ï¼Œå…¶ViewControllersåˆ†åˆ«æ˜¯4ä¸ª**MMUINavigationController**ã€‚
æ ¹æ®åå­—æˆ‘ä»¬ä¹Ÿèƒ½å¤§æ¦‚çŒœå‡ºç‚¹ä»€ä¹ˆã€‚

- NewMainFrameViewController å°±æ˜¯å¾®ä¿¡èŠå¤©ä¼šè¯æ§åˆ¶å™¨
  - **BaseMsgContentViewController** å¯¹åº”çš„å°±æ˜¯æˆ‘ä»¬çš„èŠå¤©ç•Œé¢æ§åˆ¶å™¨äº†ï¼Œæ ¹æ®åé¢**state: appeared, view: <UIView 0x1122f9060>**ä¹Ÿèƒ½å¾—å‡ºè¯¥ç»“è®ºã€‚
- ContactsViewController é€šè®¯å½•
- FindFriendEntryViewController å‘ç°
- MoreViewController æˆ‘     

æˆ‘ä»¬çš„ç„¦ç‚¹æ˜¯**BaseMsgContentViewController 0x109b86c00**ã€‚

ä¸‹é¢æ¥çœ‹çœ‹BaseMsgContentViewControlleræœ‰ä»€ä¹ˆä¸œè¥¿

```
*#0x109b86c00 // 0x109b86c00 å¯¹åº”ä¸ºBaseMsgContentViewControllerçš„å†…å­˜åœ°å€
{isa:NSKVONotifying_BaseMsgContentViewController,_hasOverrideClient:false,_hasOverrideHost:false ..... //çœç•¥æ±‚
```

> é¢˜å¤–è¯ï¼šBaseMsgContentViewController çš„isaæŒ‡é’ˆæŒ‡å‘äº†NSKVONotifying_BaseMsgContentViewControllerï¼NSKVONotifyingè¿™ä¸ªå‰ç¼€æ˜¯ä»€ä¹ˆ?æœ‰å…´è¶£æƒ³äº†è§£çš„åŒå­¦å¯ä»¥è‡ªå·±å»æœç´¢å¯»æ‰¾ä»¥ä¸‹ç­”æ¡ˆã€‚

å‘ç°ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„å˜é‡**m_arrMessageNodeData**

![](/images/1564382946892.jpg)

é¡¾åæ€ä¹‰ï¼Œæ¶ˆæ¯èŠ‚ç‚¹æ•°ç»„ï¼Œä¸éš¾çŒœå‡ºï¼Œè¿™å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„èŠå¤©ç•Œé¢æ•°æ®æºã€‚

#### 1.2 ä¸ºæ¶ˆæ¯èŠ‚ç‚¹æ¨¡å‹æ·»åŠ NSStringå±æ€§ã€‚

ç®€å•ç»Ÿè®¡ä¸€ä¸‹ï¼Œæˆ‘çš„ç•Œé¢ä¸Šæœ‰å››ç§MessageNodeç±»å‹ã€‚åˆ†åˆ«æ˜¯
    

- ChatTimeViewModel
- TextMessageViewModel
- ImageMessageViewModel
- SystemMessageViewModel

æ€è€ƒä¸€ä¸‹ï¼Œè¿™ä¸ªNSStringç±»å‹å±æ€§æ€ä¹ˆåŠ åˆ°ViewModelå‘¢ï¼Ÿæ¯ä¸ªä¸åŒçš„ViewModelç±»å‹éƒ½åŠ ä¸Šï¼Œè¿˜æ˜¯åˆ¤æ–­å®ƒä»¬æ˜¯å¦æœ‰å…±åŒçš„çˆ¶ç±»ï¼ŒåŠ åˆ°å…¶çˆ¶ç±»ä¸Šå‘¢ã€‚ç­”æ¡ˆæ˜¾è€Œæ˜“è§ï¼Œé€‰æ‹©åè€…æ–¹æ³•ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦æ¢ç´¢å®ƒä»¬çš„ç»§æ‰¿å…³ç³»äº†ã€‚
å¸¸ç”¨çš„æœ‰ä¸¤ç§æ–¹æ³•ï¼š

```
1. åœ¨class-dumpæ–‡ä»¶å¤¹ä¸­ï¼Œcommand + F æœç´¢ç›¸å…³ç±»åï¼Œæ‹¿åˆ°ç›¸å…³ç±»åçš„çˆ¶ç±»ï¼Œä¾æ­¤ç±»æ¨ã€‚ã€‚
2. åœ¨LLDBæˆ–è€…Cycriptä¸­ï¼Œè°ƒç”¨å®ä¾‹çš„ç§æœ‰æ–¹æ³•_shortMethodDescription æˆ–è€… _ivarDescriptionéƒ½å¯ä»¥ã€‚
```

è¿™é‡Œé‡‡ç”¨ç¬¬äºŒç§æ–¹æ³•ï¼ˆå› ä¸ºæ‡’å•Šï¼‰ã€‚

åœ¨Xcodeä¸­ï¼Œå…ˆæš‚åœç¨‹åºï¼ŒLLDBä¸­è¾“å…¥ä»¥ä¸‹ä»£ç ï¼š

```
po [0x1136d7df0 _shortMethodDescription] //0x1136d7df0 ä¸ºTextMessageViewModelç±»å‹å®ä¾‹å†…å­˜åœ°å€

```

è¾“å…¥å¦‚ä¸‹ï¼š

```
(lldb) po [0x1136d7df0 _shortMethodDescription] 
<TextMessageViewModel: 0x1136d7df0>:
in TextMessageViewModel:
	Class Methods:
		+ (BOOL) canCreateMessageViewModelWithMessageWrap:(id)arg1; (0x10220e5d4)
	Properties:
		@property (readonly, nonatomic) NSString* contentText;
		@property (readonly, nonatomic) UIFont* contentTextFont;
		@property (readonly, nonatomic) double contentTextFontLineHeight;  (@synthesize contentTextFontLineHeight = m_contentTextFontLineHeight;)
		@property (readonly, nonatomic) long parserType;
		@property (readonly, nonatomic) double labelWidth;
		@property (nonatomic) struct CGSize contentTextSize;  (@synthesize contentTextSize = m_contentTextSize;)
		@property (nonatomic) struct CGSize translatedTextSize;  (@synthesize translatedTextSize = m_translatedTextSize;)
		@property (retain, nonatomic) NSMutableArray* contentTextStyles;  (@synthesize contentTextStyles = m_contentTextStyles;)
		@property (nonatomic) double translatedLineY;  (@synthesize translatedLineY = _translatedLineY;)
		@property (nonatomic) double contentMidY;  (@synthesize contentMidY = _contentMidY;)
	Instance Methods:
		- (id) cellViewClassName; (0x10220e700)
		- (struct CGSize) measureContentViewSize:(struct CGSize)arg1; (0x10220ef60)
		- (struct CGSize) contentTextSize; (0x10220f918)
		- (id) translateInfo; (0x10220fcd0)
		- (BOOL) canShowTranslatedText; (0x10220fb7c)
		- (double) translatedLineY; (0x102210084)
		- (BOOL) canShowTranslateBottomView; (0x10220fa60)
		- (double) contentMidY; (0x1022100a4)
		- (id) contentTextFont; (0x10220f6b8)
		- (long) parserType; (0x10220f908)
		- (id) contentTextStyles; (0x10220f9a0)
		- (struct CGRect) realFrameByCurFrame:(struct CGRect)arg1; (0x102210034)
		- (void) setLinkHighlighted:(BOOL)arg1 url:(id)arg2; (0x10220fd84)
		- (struct CGSize) calculateContentTextSize; (0x10220ea30)
		- (void) setContentTextStyles:(id)arg1; (0x102210070)
		- (void) setTranslatedLineY:(double)arg1; (0x102210094)
		- (void) setContentMidY:(double)arg1; (0x1022100b4)
		- (void) setContentTextSize:(struct CGSize)arg1; (0x102210048)
		- (id) initWithMessageWrap:(id)arg1 contact:(id)arg2 chatContact:(id)arg3; (0x10220e5dc)
		- (void) resetLayoutCache; (0x10220e974)
		- (BOOL) isLongSplitMessage; (0x10229b20c)
		- (id) subViewModels; (0x10229b2a0)
		- (id) contentPatternText; (0x10220f6cc)
		- (struct CGSize) translatedTextSize; (0x10220f95c)
		- (struct CGSize) calculateTranslatedTextSize; (0x10220ecf0)
		- (double) contentTextFontLineHeight; (0x102210038)
		- (void) setTranslatedTextSize:(struct CGSize)arg1; (0x10221005c)
		- (id) cellDataForRow:(unsigned long)arg1; (0x10220e798)
		- (void) updateChatContact:(id)arg1; (0x10220e81c)
		- (void) .cxx_destruct; (0x1022100c4)
		- (void) setHighlighted:(BOOL)arg1; (0x10220f28c)
		- (double) labelWidth; (0x10220f9e0)
		- (id) contentText; (0x10220f418)
		- (long) numberOfRowsInSection; (0x10220e72c)
		- (id) accessibilityDescription; (0x10220f1e8)
in CommonMessageViewModel:
	Instance Methods:
		- (void) OnMsgDownloadAppAttachSuccess:(id)arg1 MsgWrap:(id)arg2; (0x102377b40)
		- (BOOL) isShowAppMessageBlockButton; (0x1023770d4)
		- (id) sourceTitle; (0x102376d94)
		- (id) sourceIcon; (0x102376fa8)
		- (id) sourceTag; (0x1023770c4)
		- (BOOL) isShowSourceView; (0x102376a3c)
		- (BOOL) souceIconBgIsShow; (0x1023770cc)
		- (id) bgBubbleInfo; (0x102377238)
		- (id) maskBubbleInfo; (0x102377314)
		- (struct CGSize) measure:(struct CGSize)arg1; (0x1023773f0)
		- (id) initWithMessageWrap:(id)arg1 contact:(id)arg2 chatContact:(id)arg3; (0x102376564)
		- (BOOL) calIsShowChatRoomDisplayName; (0x102376924)
		- (void) updateChatContact:(id)arg1; (0x1023767fc)
		- (BOOL) isShowHeadImage; (0x1023768f8)
		- (BOOL) isShowChatRoomDisplayName; (0x102376914)
		- (BOOL) shouldShowSourceViewInContent; (0x102376d8c)
		- (BOOL) isShowSendingView; (0x10237719c)
		- (BOOL) isShowSendFailView; (0x102377204)
		- (void) dealloc; (0x10237670c)
		- (id) accessibilityDescription; (0x102377c0c)
in BaseMessageViewModel:
	Class Methods:
		+ (BOOL) canCreateMessageViewModelWithMessageWrap:(id)arg1; (0x101df770c)
		+ (void) registerMessageViewModelClass:(Class)arg1; (0x101df6ff8)
		+ (void) initMessageViewModelClassList; (0x101df700c)
		+ (id) createMessageViewModelWithMessageWrap:(id)arg1 contact:(id)arg2 chatContact:(id)arg3; (0x101df7530)
	Properties:
		@property (readonly, nonatomic) unsigned int msgStatus;
		@property (retain, nonatomic) CBaseContact* contact;  (@synthesize contact = m_contact;)
		@property (retain, nonatomic) CMessageWrap* messageWrap;  (@synthesize messageWrap = m_messageWrap;)
		@property (readonly, nonatomic) BOOL isSender;  (@synthesize isSender = m_isSender;)
		@property (retain, nonatomic) NSString* cpKeyForChatRoomMessage;  (@synthesize cpKeyForChatRoomMessage = m_cpKeyForChatRoomMessage;)
		@property (retain, nonatomic) NSString* cpKeyForChatRoomDisplayName;  (@synthesize cpKeyForChatRoomDisplayName = m_cpKeyForChatRoomDisplayName;)
		@property (nonatomic) BOOL isChatRoomMessageUnsafe;  (@synthesize isChatRoomMessageUnsafe = m_isChatRoomMessageUnsafe;)
		@property (nonatomic) BOOL isChatRoomDisplayNameUnsafe;  (@synthesize isChatRoomDisplayNameUnsafe = m_isChatRoomDisplayNameUnsafe;)
		@property (nonatomic) BOOL isShowStatusView;  (@synthesize isShowStatusView = _isShowStatusView;)
		@property (nonatomic) BOOL highlighted;  (@synthesize highlighted = _highlighted;)
		@property (readonly, nonatomic) struct CGSize contentViewSize;  (@synthesize contentViewSize = m_contentViewSize;)
		@property (readonly) unsigned long hash;
		@property (readonly) Class superclass;
		@property (readonly, copy) NSString* description;
		@property (readonly, copy) NSString* debugDescription;
	Instance Methods:
		- (struct CGSize) measureContentViewSize:(struct CGSize)arg1; (0x101df8af0)
		- (id) additionalAccessibilityDescription; (0x101df8638)
		- (unsigned int) msgStatus; (0x101df9214)
		- (struct CGSize) measure:(struct CGSize)arg1; (0x101df89e8)
		- (id) initWithMessageWrap:(id)arg1 contact:(id)arg2 chatContact:(id)arg3; (0x101df7714)
		- (void) resetLayoutCache; (0x101df898c)
		- (void) setIsShowStatusView:(BOOL)arg1; (0x101df917c)
		- (void) updateCrashProtectedState; (0x101df8640)
		- (void) onMessageUpdateStatus; (0x101df9038)
		- (id) chatRoomDisplayName; (0x101df8b00)
		- (BOOL) isShowSendOKView; (0x101df8784)
		- (void) updateContentViewHeight:(double)arg1; (0x101df8864)
		- (void) setMessageWrap:(id)arg1; (0x101df90ac)
		- (id) cpKeyForChatRoomMessage; (0x101df90d0)
		- (void) setCpKeyForChatRoomMessage:(id)arg1; (0x101df90e0)
		- (id) cpKeyForChatRoomDisplayName; (0x101df90f4)
		- (void) setCpKeyForChatRoomDisplayName:(id)arg1; (0x101df9104)
		- (BOOL) isChatRoomMessageUnsafe; (0x101df9118)
		- (void) setIsChatRoomMessageUnsafe:(BOOL)arg1; (0x101df9128)
		- (BOOL) isChatRoomDisplayNameUnsafe; (0x101df9138)
		- (void) setIsChatRoomDisplayNameUnsafe:(BOOL)arg1; (0x101df9148)
		- (BOOL) isShowStatusView; (0x101df916c)
		- (id) messageWrap; (0x101df909c)
		- (void) .cxx_destruct; (0x101df91ac)
		- (void) dealloc; (0x101df7924)
		- (void) setHighlighted:(BOOL)arg1; (0x101df919c)
		- (BOOL) highlighted; (0x101df918c)
		- (struct CGSize) contentViewSize; (0x101df9158)
		- (id) contact; (0x101df9078)
		- (BOOL) isSender; (0x101df90c0)
		- (void) setContact:(id)arg1; (0x101df9088)
		- (id) accessibilityDescription; (0x101df7a60)
in BaseChatViewModel:
	Properties:
		@property (readonly, nonatomic) CMessageWrap* messageWrap;
		@property (weak, nonatomic) id cellView;
		@property (nonatomic) int modelType;  (@synthesize modelType = _modelType;)
		@property (nonatomic) unsigned long splitPosition;  (@synthesize splitPosition = _splitPosition;)
		@property (retain, nonatomic) CBaseContact* chatContact;  (@synthesize chatContact = m_chatContact;)
		@property (nonatomic) double createTime;  (@synthesize createTime = _createTime;)
		@property (weak, nonatomic) <ChatViewModelDelegate>* delegate;  (@synthesize delegate = _delegate;)
	Instance Methods:
		- (void) setCreateTime:(double)arg1; (0x1023815d8)
		- (id) cellViewClassName; (0x10238108c)
		- (void) updateLayouts; (0x1023812e4)
		- (BOOL) isHeadPart; (0x102381460)
		- (BOOL) isTailPart; (0x1023814ac)
		- (void) setCellView:(id)arg1; (0x1017adab0)
		- (BOOL) shouldLayoutIfNeeded; (0x102381168)
		- (struct CGSize) measure:(struct CGSize)arg1; (0x1023812c4)
		- (BOOL) isDisableEditMode; (0x1023814f8)
		- (void) resetLayoutCache; (0x1023812d4)
		- (id) initWithChatContact:(id)arg1; (0x102380f50)
		- (id) cellDataForRow:(unsigned long)arg1; (0x10238145c)
		- (void) updateChatContact:(id)arg1; (0x102380fd4)
		- (void) setChatContact:(id)arg1; (0x102381574)
		- (double) createTime; (0x1023815c8) //æˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯
		- (id) messageWrap; (0x102381668)
		- (id) chatContact; (0x102381564)
		- (void) .cxx_destruct; (0x10238161c)
		- (void) setDelegate:(id)arg1; (0x102381608)
		- (double) rowHeight; (0x102381218)
		- (id) delegate; (0x1023815e8)
		- (void) setModelType:(int)arg1; (0x102381598)
		- (int) modelType; (0x102381588)
		- (unsigned long) splitPosition; (0x1023815a8)
		- (void) setSplitPosition:(unsigned long)arg1; (0x1023815b8)
		- (long) numberOfRowsInSection; (0x102381454)
		- (id) cellView; (0x1017adac8)
		- (id) cellIdentifier; (0x102381094)
		- (double) sectionHeight; (0x1023810a0)
(NSObject ...)

```

å¯ä»¥çœ‹åˆ°å…¶çš„ç»§æ‰¿å…³ç³»ä¸º

```
TextMessageViewModel --> CommonMessageViewModel --> BaseMessageViewModel --> BaseChatViewModel --> NSObject

```

æ­¤å¤–æˆ‘ä»¬è¿˜èƒ½å¾—åˆ°ä¸€ä¸ªå¾ˆé‡è¦çš„ä¿¡æ¯ã€‚

***è°ƒç”¨BaseChatViewModelçš„createTimeæ–¹æ³•å³å¯æ‹¿åˆ°æ¶ˆæ¯çš„åˆ›å»ºæ—¶é—´ã€‚***

ä¾æ­¤ç±»æ¨ï¼Œåˆ†åˆ«æ•´ç†å¾—å‡º

![](/images/1564382971178.jpg)

**BaseChatViewModel**ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æœ¬æ¬¡ä»»åŠ¡ç›®æ ‡ï¼Œä¸ºå…¶æ·»åŠ ä¸€ä¸ªNSString*ç±»å‹çš„intervaleTimeå±æ€§ï¼š

```
CHDeclareClass(BaseChatViewModel) // å£°æ˜ä¸€ä¸ªç±»
CHPropertyCopyNonatomic(BaseChatViewModel, NSString *, intervaleTime, setIntervaleTime); // ä¸ºå…¶æ·»åŠ ä¸€ä¸ªå±æ€§ï¼Œgetter æ–¹æ³•ä¸º intervaleTimeï¼Œ setteræ–¹æ³•ä¸ºsetIntervaleTime

```

### 2. åœ¨æ°å½“çš„ä½ç½®è·å–æ•°æ®æºï¼Œè®¡ç®—æ¶ˆæ¯å‘é€é—´éš”æ—¶é—´ï¼Œå¹¶æ›´æ–°

æ€è€ƒï¼Œå¦‚ä½•æ‰¾åˆ°æ‰¾åˆ°æ°å½“çš„ä½ç½®è·å–æ•°æ®æºï¼Ÿ

![](/images/1564382985200.jpg)

é€šè¿‡Xcodeçš„Debug View HierarchyåŠŸèƒ½å¯çŸ¥æ•°æ®çš„èŠå¤©ç•Œé¢æ˜¯ç”±UITableViewçš„ä¸€ä¸ªå­ç±»YYTableViewå®ç°çš„ã€‚ï¼ˆYYKitçš„ä½œè€…éƒ­å¤§ç¥å†™çš„å—ï¼Ÿï¼‰

**æ—¢ç„¶å¦‚æ­¤ï¼Œhook â€œ-[UITableView reloadData]â€ï¼Œè§‚çœ‹ä¸€ä¸‹å †æ ˆï¼Œçœ‹çœ‹æ˜¯å¦èƒ½æ‰¾åˆ°ä¸€ä¸ªæ°å½“çš„ä½ç½®è·å–æ•°æ®æºã€‚**

LLDBä¸­è¾“å…¥ï¼š

`(lldb) br s -n "-[UITableView reloadData]"
`
OKï¼Œé€€å›ä¼šè¯ç•Œé¢ï¼Œé‡æ–°è¿›å…¥èŠå¤©çª—å£ç•Œé¢ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ **-initTableView** è¿™ä¸ªæ–¹æ³•å›è°ƒç”¨reloadDataçš„æ–¹æ³•ï¼š

```
(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 3.1
  * frame #0: 0x000000018db5c6e4 UIKit`-[UITableView reloadData]
    frame #1: 0x0000000102559fb8 WeChat`-[MMTableView reloadData] + 76
    frame #2: 0x0000000101b9466c WeChat`-[BaseMsgContentViewController initTableView] + 1136
    frame #3: 0x0000000101bb0c50 WeChat`-[BaseMsgContentViewController ReloadView] + 1348
    frame #4: 0x00000001023660f4 WeChat`-[MMMsgLogicManager PushLogicControllerByContact:navigationController:animated:jumpToLocationNode:reuse:extraInfo:] + 1248
    frame #5: 0x0000000105bc6324 
    ...... 
```

å¾€ä¸‹æ»‘ï¼ŒåŠ è½½å†å²æ¶ˆæ¯æ—¶å€™ï¼Œåœ¨ **-onLoadMoreMessage** æ–¹æ³•ä¹‹å†…å†æ¬¡è°ƒç”¨reloadDataï¼Œè§¦å‘æ–­ç‚¹ï¼š

```
(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 3.1
  * frame #0: 0x000000018db5c6e4 UIKit`-[UITableView reloadData]
    frame #1: 0x0000000102559fb8 WeChat`-[MMTableView reloadData] + 76
    frame #2: 0x0000000101b92940 WeChat`-[BaseMsgContentViewController onLoadMoreMessage] + 672
...
```

å‘é€ä¸€æ¡æ¶ˆæ¯æ—¶æˆ–è€…æ¥æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯çš„æ—¶å€™ï¼Œåœ¨æ–¹æ³• **-addMessageNode:layout:addMoreMsg:** è°ƒç”¨reloadDataï¼Œè§¦å‘æ–­ç‚¹ï¼š

```
(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 3.1
  * frame #0: 0x000000018db5c6e4 UIKit`-[UITableView reloadData]
    frame #1: 0x0000000102559fb8 WeChat`-[MMTableView reloadData] + 76
    frame #2: 0x0000000101b91e7c WeChat`-[BaseMsgContentViewController addMessageNode:layout:addMoreMsg:] + 1896
    frame #3: 0x0000000101e03e18 WeChat`-[BaseMsgContentLogicController DidAddMsg:] + 520
    frame #4: 0x0000000101ded8c8 WeChat`-[BaseMsgContentLogicController OnAddMsg:MsgWrap:] 
...
```

è¿™ä¼¼ä¹ä¸æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œå› ä¸ºè¿›è¡Œhookçš„ä»£ç åªèƒ½åœ¨ç›®æ ‡å‡½æ•°æ‰§è¡Œå‰æˆ–è€…æ‰§è¡Œåè¿›è¡Œï¼Œè€Œæˆ‘ä»¬éœ€è¦çš„ä½ç½®åº”è¯¥æ˜¯åœ¨reloadDataå‰è¿›è¡Œhookã€‚

æ€ä¹ˆåŠå‘¢ï¼Ÿ

**UITableViewæ»‘åŠ¨çš„æ—¶å€™æ€»è¦æ‰§è¡ŒdataSourceæ–¹æ³•å§ï¼Œé€€æ±‚å…¶æ¬¡ï¼Œåœ¨- tableView:cellForRowAtIndexPath: ä¸­è¿›è¡Œhookã€‚**

é¦–å…ˆè§‚å¯ŸèŠå¤©çª—å£ä¸­tableViewçš„dataSourceå¯¹è±¡æ˜¯è°

åœ¨Xcodeçš„Debug View Hierarchy ä¸­æŸ¥çœ‹tableViewçš„åœ°å€,æ‰“å°dataSource

```
<YYTableView: 0x145b30a00; baseClass = UITableView; frame = (0 0; 320 568); clipsToBounds = YES; gestureRecognizers = <NSArray: 0x14762c5e0>; layer = <CALayer: 0x147419910>; contentOffset: {0, 814}; contentSize: {320, 3511}>
(lldb) po [0x145b30a00 dataSource]
delegate[0x1472ee430], class[YYMultiTargetDelegate]
(lldb) po [0x1472ee430 _shortMethodDescription]
<YYMultiTargetDelegate: 0x1472ee430>:
in YYMultiTargetDelegate:
	Instance Methods:
		- (void) .cxx_destruct; (0x1024c1c48)
		- (BOOL) respondsToSelector:(SEL)arg1; (0x1024c1b08)
		- (id) methodSignatureForSelector:(SEL)arg1; (0x1024c197c)
		- (id) forwardingTargetForSelector:(SEL)arg1; (0x1024c1838)
		- (void) forwardInvocation:(id)arg1; (0x1024c183c)
		- (id) initWithTargets:(id)arg1; (0x1024c1650)
(NSObject ...)

```

ä¸€ä¸ªYYMultiTargetDelegateçš„ç±»ï¼Œå¹¶æ²¡æœ‰å®ç°UITableViewDataSourceæ–¹æ³•ï¼Œè€Œæ˜¯è¿›è¡Œæ¶ˆæ¯è½¬å‘ã€‚

å®¹æˆ‘åšä¸ªæ‚²ä¼¤çš„è¡¨æƒ…ï¼Œæ¢ä¸ªå§¿åŠ¿æ‰“æ–­ç‚¹ï¼Œ

`(lldb) br s --func-regex tableView:cellForRowAtIndexPath:
`

ç¬¦åˆä¸Šé¢å‡½æ•°å…³é”®å­—éƒ½ä¼šä¸‹æ–­ç‚¹ã€‚è¯•ç€æ»‘åŠ¨ä¸€ä¸‹èŠå¤©ç•Œé¢ï¼Œè§¦å‘æ–­ç‚¹ï¼Œå †æ ˆå¦‚ä¸‹ï¼š

```
(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 6.175
  * frame #0: 0x0000000101b99e08 WeChat`-[BaseMsgContentViewController tableView:cellForRowAtIndexPath:]
    frame #1: 0x0000000105bc8474 libWeChatPlugInDylib.dylib`$BaseMsgContentViewController_tableView$cellForRowAtIndexPath$_method(self=0x00000001462f6c00, _cmd="tableView:cellForRowAtIndexPath:", arg1=0x0000000145b30a00, arg2=0xc000000000001c16) at WeChatPlugInDylib.m:612
    frame #2: 0x0000000187954e80 CoreFoundation`__invoking___ + 144
    frame #3: 0x000000018784a2b4 CoreFoundation`-[NSInvocation invoke] + 292
    frame #4: 0x000000018784ee7c CoreFoundation`-[NSInvocation invokeWithTarget:] + 60
    frame #5: 0x00000001024c1904 WeChat`-[YYMultiTargetDelegate forwardInvocation:] + 200
    frame #6: 0x0000000187952d4c CoreFoundation`___forwarding___ + 404
    frame #7: 0x000000018784ed2c CoreFoundation`_CF_forwarding_prep_0 + 92

```

å‘µå‘µï¼Œç»•äº†ä¸€åœˆï¼Œè¿˜æ˜¯å›åˆ°äº†**BaseMsgContentViewController**ã€‚
è‡³æ­¤ï¼Œåˆé€‚çš„ä½ç½®å·²ç»æ‰¾åˆ°äº†å°±æ˜¯**-[BaseMsgContentViewController tableView:cellForRowAtIndexPath:]**ï¼Œå°±ä¸‹æ¥å°±æ˜¯ç¼–å†™hookå‡½æ•°äº†ã€‚

```
CHDeclareClass(BaseMsgContentViewController)

// æ–°å¢ä¸€ä¸ªæ–¹æ³•
CHDeclareMethod(1, NSString*,BaseMsgContentViewController,getTimeIntervalDescriptionWithTime,NSInteger,arg1){
    NSTimeInterval time = arg1;
    NSInteger seconds = time;
    if (seconds < 60) {
        if (seconds <= 0) {
            seconds = 1;
        }
        return [NSString stringWithFormat:@"%lds",seconds];
    }
    //ç§’è½¬åˆ†é’Ÿ
    NSInteger minute = time/60;
    if (minute < 60) {
        return [NSString stringWithFormat:@"%ldm",minute];
    }
    
    // ç§’è½¬å°æ—¶
    NSInteger hours = time/3600;
    if (hours<24) {
        return [NSString stringWithFormat:@"%ldh",hours];
    }
    //ç§’è½¬å¤©æ•°
    NSInteger days = time/3600/24;
    if (days < 30) {
        return [NSString stringWithFormat:@"%ldD",days];
    }
    //æ ¼å¼åŒ–æ—¥æœŸå¯¹è±¡æ ¼å¼
    return @"...";
}
// hook çš„æ–¹æ³• 
CHOptimizedMethod(2, self,UITableViewCell *,BaseMsgContentViewController,tableView,UITableView*,arg1,cellForRowAtIndexPath,NSIndexPath *,arg2){
    

    NSMutableArray *arrMessageNodeData = CHIvar(self, m_arrMessageNodeData, __strong NSMutableArray *);
    id node = arrMessageNodeData[arg2.section]; // é€šè¿‡æ‰“å°å¾—çŸ¥ï¼Œï¼Œå¾®ä¿¡çš„ä¸€ä¸ªCellæ˜¯sectionè€Œä¸æ˜¯rowã€‚
    if (![node isKindOfClass:NSClassFromString(@"ChatTimeViewModel")] && [node intervaleTime] == nil ) {
        CommonMessageViewModel *msgNode = (CommonMessageViewModel *)node;
        CommonMessageViewModel *preMsgNode = nil;
        NSInteger preIndex = arg2.section - 1;
        if (preIndex >= 0) {
            for (NSInteger i = preIndex; i >= 0; i--) {
                id preNode = arrMessageNodeData[i];
                if ([preNode isKindOfClass:NSClassFromString(@"ChatTimeViewModel")]) {
                    continue;
                }else{
                    preMsgNode = (CommonMessageViewModel *)preNode;
                    break;
                }
            }
        }
        if (preMsgNode) {           
            msgNode.intervaleTime = [self getTimeIntervalDescriptionWithTime:msgNode.createTime - preMsgNode.createTime];
        }
    }

    return CHSuper(2, BaseMsgContentViewController,tableView,arg1,cellForRowAtIndexPath,arg2);
}

```

- ç¬¬ä¸€ä¸ªæ–¹æ³•æ˜¯æ–°æ·»çš„ï¼Œä¸»è¦æ˜¯å°†æ—¶é—´ç§’æ•°è½¬æ¢æˆè¦æ˜¾ç¤ºçš„å­—ç¬¦ä¸²ã€‚
- ç¬¬ä¸€ä¸ªæ–¹æ³•å°±æ˜¯è¦hookçš„æ–¹æ³•ï¼Œæ¶ˆæ¯æ—¶é—´çš„è®¡ç®—é—´éš”çœ‹ä»£ç å°±å¥½äº†ï¼Œå°±ä¸å†åšè¯¦ç»†æè¿°äº†ã€‚

### 3. æ‰¾åˆ°èŠå¤©çš„Cellï¼Œruntimeæ·»åŠ æ˜¾ç¤ºæ¶ˆæ¯å‘é€é—´éš”UILabelè§†å›¾ã€‚

æ•°æ®æœ‰äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æUIäº†ã€‚å…ˆäº†è§£ä¸€ä¸‹èŠå¤©Cellçš„ç»„æˆã€‚

![](/images/1564383008284.jpg)

```
* èŠå¤©ç•Œé¢ä¸­ï¼Œæ‰€æœ‰çš„Celléƒ½æ˜¯ChatTableViewCellç±»å‹ï¼ˆçº¢è‰²åœˆï¼‰ã€‚
* ä¸åŒç±»å‹çš„CellViewæ˜¯ChatTableViewCellçš„contentViewçš„å­è§†å›¾ï¼ˆè“è‰²åœˆï¼‰ã€‚
```

å‡­ç¼–ç¨‹ç»éªŒï¼ŒçŒœæµ‹ï¼Œå¾®ä¿¡å°±æ˜¯é€šè¿‡ä¼ å…¥ä¸åŒç±»å‹çš„MessageNodeåˆ›å»ºä¸åŒçš„CellViewï¼ˆè“è‰²åœˆï¼‰ï¼Œç„¶åç»Ÿä¸€åŠ å…¥åˆ°ChatTableViewCellçš„contentViewä¸­ã€‚

> è¯´ä¸ªé¢˜å¤–è¯ï¼Œé€†å‘ï¼Œä¹Ÿæ— éæ˜¯çŒœï¼Œçœ‹è°çŒœçš„å‡†ï¼Œä»UIçŒœï¼Œä»ç±»åçŒœï¼Œä»ç±»æ–¹æ³•ï¼Œå®ä¾‹æ–¹æ³•åçŒœï¼Œé…åˆhookæ‰“å°ï¼ŒéªŒè¯è‡ªå·±çš„æƒ³æ³•ã€‚çŒœçš„å‡†ä¸å‡†å–å†³æ­£å‘å¼€å‘ç»éªŒï¼Œæ‰€ä»¥è§‰å¾—é€†å‘å¾ˆéš¾çš„åŒå­¦ï¼Œæ¨èå…ˆæé«˜è‡ªå·±çš„æ­£å‘å¼€å‘èƒ½åŠ›å§ã€‚

å°±æ˜¯æ¢ç´¢ä¸åŒç±»å‹CellViewçš„å†…éƒ¨ç»§æ‰¿å…³ç³»äº†ï¼Œæ–¹æ³•è¿‡ç¨‹ä¸Šé¢è¯•æåˆ°çš„ä¸€æ ·ï¼Œé€šè¿‡

```
`po [xx _shortMethodDescription] `
```

æ•´ç†å¾—å‡ºï¼š

![](/images/1564383020655.jpg)

ChatTimeCellView ä¸ºå¾®ä¿¡å±•ç¤ºæ—¶é—´è§†å›¾ï¼Œä¸å±äºå¯¹æ–¹å‘å‡ºçš„ï¼Œå› æ­¤ä¸å…³æ³¨ã€‚

é€”ä¸­è¿˜å¾—åˆ°ä¸€äº›å¯èƒ½å¯¹æˆ‘ä»¬æœ‰å¸®åŠ©çš„ä¿¡æ¯ï¼š

```
in ImageMessageCellView
    - (void) layoutContentView; (0x101f76c80)
    - (void) updateStatus; (0x101f76f60)
    
in CommonMessageCellView
    - (void) layoutContentView; (0x102384778)
    - (void) addCancelButton; (0x102386934)
    - (void) addSendFailButton; (0x102386630)
    - (void) addSendingView; (0x10238651c)
    - (void) updateStatus; (0x101d53180)
in BaseMessageCellView:
    @property (readonly, nonatomic) BaseMessageViewModel* viewModel;  (@dynamic viewModel;)
    - (void) layoutContentView; (0x101d52fbc)
    - (void) addSendOKView; (0x101d535ac)
    - (void) updateStatus; (0x101d53180)
in BaseChatCellView:
    @property (readonly, nonatomic) BaseChatViewModel* viewModel;
    - (void) layoutFinished;
    - (id) viewModel; (0x101cfc270)
    - (void) setViewModel:(id)arg1; (0x101cfbfc8)
    - (id) initWithViewModel:(id)arg1; (0x101cfbf50)

```

  -(id) initWithViewModel:(id)arg1; (0x101cfbf50) è¿™ä¸ªçœ‹èµ·æ¥åº”è¯¥å°±æ˜¯å®ƒä»¬ç»Ÿä¸€çš„æ„é€ æ–¹æ³•äº†ï¼Œæ‰“ä¸ªæ–­ç‚¹éªŒè¯ä¸€ä¸‹ï¼š

```
(lldb) br s --func-regex initWithViewModel:
Breakpoint 2: 15 locations.
(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 2.14
  * frame #0: 0x000000010245ea4c WeChat`-[CommonMessageCellView initWithViewModel:]
    frame #1: 0x0000000105c633a8 libWeChatPlugInDylib.dylib`$CommonMessageCellView_initWithViewModel$_method(self=0x00000001154bfe90, _cmd="initWithViewModel:", arg1=0x0000000119e4d360) at WeChatPlugInDylib.m:515
    frame #2: 0x000000010148ae28 WeChat`-[ChatTableViewCell setViewModel:] + 368
    frame #3: 0x0000000101c755c4 WeChat`-[BaseMsgContentViewController makeCell:indexPath:] + 196
    frame #4: 0x0000000101c75fd0 WeChat`-[BaseMsgContentViewController tableView:cellForRowAtIndexPath:] + 456
    frame #5: 0x0000000105c64474 
    .... çœç•¥
    
(lldb) p (SEL)$x1
(SEL) $2 = "initWithViewModel:"
(lldb) po $x0
<EmoticonMessageCellView: 0x11866cde0; frame = (0 0; 0 0); transform = [0, 0, 0, 0, 0, 0]; alpha = 0; opaque = NO; layer = (null)>

(lldb) po $x2
<EmoticonMessageViewModel: 0x1186c9930>

(lldb) 

```

éªŒè¯äº†ä¹‹å‰æˆ‘ä»¬çš„çŒœæµ‹ï¼Œåœ¨**-[ChatTableViewCell setViewModel:]**å†…éƒ¨è°ƒç”¨äº†**-[CommonMessageCellView initWithViewModel:]**æ–¹æ³•ï¼Œä¼ å…¥ä¸åŒçš„ViewModelåˆ›å»ºå‡ºä¸åŒçš„CellViewã€‚

CommonMessageCellViewï¼ŒBaseMessageCellViewï¼ŒBaseChatCellViewéƒ½å¯ä»¥è¿›è¡Œæ·»åŠ æ˜¾ç¤ºæ¶ˆæ¯å‘é€é—´éš”UILabelè§†å›¾ã€‚ï¼ˆåœ¨è¿™é‡Œæˆ‘å–äº†CommonMessageCellViewï¼‰ã€‚ç¼–å†™ä»£ç å¦‚ä¸‹ï¼š

```
CHDeclareClass(CommonMessageCellView)
CHPropertyRetainNonatomic(CommonMessageCellView, UIView *, expandView, setExpandView);

CHOptimizedMethod(1, self,id,CommonMessageCellView,initWithViewModel,BaseChatViewModel *,arg1){
    CommonMessageCellView *view =  CHSuper(1,CommonMessageCellView,initWithViewModel,arg1);
    view.expandView = [[UILabel alloc] init];
    view.expandView.font = [UIFont systemFontOfSize:12];
    return view;
}


```

### 4. æ‰¾åˆ°èŠå¤©Cellå¸ƒå±€æ›´æ–°æ–¹æ³•ï¼Œè®¾ç½®æ˜¾ç¤ºæ¶ˆæ¯å‘é€é—´éš”ã€‚

é€šè¿‡ä¸Šé¢çš„æ­¥éª¤ï¼Œæˆ‘ä»¬å¾—åˆ°å‡ ä¸ªå¯èƒ½å¯¹æˆ‘ä»¬æœ‰å¸®åŠ©çš„æ–¹æ³•ã€‚

- -layoutContentView;
- -updateStatus;

åœ¨hopperä¸­æœä¸€ä¸‹**layoutContentView**ï¼Œ

![](/images/1564383039560.jpg)

1. emmm... å¯ä»¥çŒœå¾—å‡ºè¿™åº”è¯¥æ˜¯æ‰€æœ‰ä¸åŒç±»å‹CellViewçš„å¸ƒå±€æ–¹æ³•äº†ï¼Œä½†æˆ‘ä»¬ä¸å¯èƒ½åœ¨æ‰€æœ‰ç±»å‹CellViewéƒ½å†™ä¸Šæˆ‘ä»¬æ¶ˆæ¯é—´éš”labelçš„è®¾ç½®ä»£ç ã€‚ã€‚

åœ¨hopperä¸­æœç´¢çœ‹çœ‹**TextMessageCellView updateStatus**çœ‹çœ‹ï¼Œæ‰‹åŠ¨æ•´ç†ä¸€ä¸‹å¾—ï¼š

```
void -[TextMessageCellView updateStatus](void * self, void * _cmd) {
    [super updateStatus];
    id btn = self->m_oTranslateStatusButton;
    [btn setHidden:self.viewMdel.xx];
    
    if (canShowTranslateBottomView){ // æ˜¯å¦å¯ä»¥æ˜¾ç¤ºç¿»è¯‘BottomView
        //åˆå§‹åŒ–ä¸€äº›æ“ä½œ
        self->m_oTranslateStatusButton = ....
    }
    returnï¼›
}


```

çœ‹ä¸å‡ºä»€ä¹ˆã€‚ã€‚

å†çœ‹çœ‹å®ƒä»¬çˆ¶ç±» **CommonMessageCellView updateStatus** çš„å®ç°ï¼Œæ‰‹åŠ¨æ•´ç†ä¼ªä»£ç ï¼š

```
void -[CommonMessageCellView updateStatus](void * self, void * _cmd) {
    var wrap =[[self viewModel] messageWrap ];
    	if ([wrap isSender]){
		if ([[self viewModel] isShowStatusView]){
			return;
		}else{
			if ([[self viewModel] isShowSendingView] ){
				[self  addSendingView];
				return;
			}else{
				if ([[self viewModel] isShowSendFailView]){
					[self addSendFailButton];
					return;
				}else{
					if([[self viewModel] isShowSendOKView])
					{
						[self addSendOKView];
					}else{
						return;
					}
				}
			}
		}		 
	}else{
	 	return;
	}
}


```

å¯ä»¥çœ‹åˆ°æ¶ˆæ¯å‘é€çŠ¶æ€æŒ‰é’®æ˜¯åœ¨è¿™é‡Œæ·»åŠ çš„ï¼Œäºæ˜¯å°è¯•hookå‡½æ•°**CommonMessageCellView updateStatus**ï¼Œæ‰“åŒ…è¿è¡Œï¼Œæ•ˆæœå›¾å¦‚ä¸‹ï¼š

![](/images/1564383056334.jpg)

æ­¤å¤„åº”è¯¥æŒå£°ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘ï¼

ç­‰ä¸€ä¸‹ï¼ŒImageMessageCellViewçš„æ—¶é—´é—´éš”Cellæ€ä¹ˆæ²¡äº†å‘¢ï¼Ÿï¼Ÿéš¾é“ImageMessageCellViewä¸èµ°[super updateStatus]æ–¹æ³•ï¼Ÿï¼Ÿ

è¿›Hopperè§‚å¯Ÿä¸€ä¸‹-[ImageMessageCellView updateStatus]ï¼š

![](/images/1564383069625.jpg)

æ²¡æœ‰å‘ç°updateStatusç­‰å­—æ ·ï¼Œæœç„¶ä¸æ‰§è¡Œ[super updateStatus]ã€‚

æ‰“æ–­ç‚¹è§‚å¯Ÿ-[ImageMessageCellView updateStatus]è°ƒç”¨æ ˆï¼š

```
(lldb) br s -n "-[ImageMessageCellView updateStatus]"
Breakpoint 3: where = WeChat`-[ImageMessageCellView updateStatus], address = 0x0000000102032f60
(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 3.1
  * frame #0: 0x0000000102032f60 WeChat`-[ImageMessageCellView updateStatus]
    frame #1: 0x0000000105c8e8f4 libWeChatPlugInDylib.dylib`$CommonMessageCellView_updateNodeStatus_method(self=0x00000001636107a0, _cmd="updateNodeStatus") at WeChatPlugInDylib.m:522
    frame #2: 0x0000000101e0ef70 WeChat`-[BaseMessageCellView layoutFinished] + 28
    frame #3: 0x0000000101db8224 WeChat`-[BaseChatCellView layoutSubviews] + 216


```

æ³¨æ„ **frame #1**è¿™ä¸€è¡Œä»£ç ï¼ŒåŸæ¥åœ¨**-[CommonMessageCellView updateNodeStatus]**ä¹‹å†…æ‰ä¼šå»æ‰§è¡Œ
**-[ImageMessageCellView updateStatus]**ã€‚TextMessageCellViewä¹Ÿæ˜¯å¦‚æ­¤ã€‚

è¿™ä¸‹ï¼Œé—®é¢˜æ‰¾åˆ°äº†ï¼š

![](/images/1564383080247.jpg)

æŠŠhookæ–¹æ³•æ”¹ä¸ºå®ƒä»¬çš„ä¸Šä¸Šä¸€çº§æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯**-[CommonMessageCellView updateNodeStatus]**ï¼Œæ‰“å¼€æµ‹è¯•ä¸€ä¸‹ï¼Œå®Œç¾ï¼

![](/images/1564383093029.jpg)

æœ€ç»ˆä»£ç å¦‚ä¸‹ï¼š

```
CHOptimizedMethod(0, self,void,CommonMessageCellView,updateNodeStatus){
    CHSuper(0,CommonMessageCellView,updateNodeStatus);
    if (![[self viewModel] isSender] && [self.viewModel intervaleTime].length > 0) {
        self.expandView.text = [self.viewModel intervaleTime];
        [self.expandView sizeToFit];
        CGFloat centerX = 0,centerY = 0;
        // è¯­éŸ³CellViewçš„m_secLabelçš„ä½ç½®ä¼šä¸æ¶ˆæ¯é—´éš”labelé‡å ï¼Œç‰¹æ®Šå¤„ç†ä¸€ä¸‹
        if ([self isKindOfClass:NSClassFromString(@"VoiceMessageCellView")]) {
            UIView *m_contentView = CHIvar(self, m_contentView, __strong UIView *);
            UILabel* m_secLabel = CHIvar(self, m_secLabel, __strong UILabel *);
            CGRect frame = [self convertRect:m_secLabel.frame fromView:m_contentView];
            centerX = CGRectGetMaxX(frame) + 4 + self.expandView.bounds.size.width / 2;
            centerY = CGRectGetMidY(frame);
        }else{
            UIView *m_contentView = CHIvar(self, m_contentView, __strong UIView *);
            centerX = CGRectGetMaxX(m_contentView.frame) + 4 + self.expandView.bounds.size.width / 2;
            centerY = CGRectGetMaxY(m_contentView.frame) - 8 - self.expandView.bounds.size.height / 2;
        }
        self.expandView.center = CGPointMake(centerX, centerY);
        [self addSubview:self.expandView];
        self.expandView.hidden = NO;
    }else{
        self.expandView.hidden = YES;
    }
}


```

## æ€»ç»“

é€†å‘è¿‡ç¨‹ä¸­åº”è¯¥ç”¨é€†å‘çš„æ€ç»´å»è§£å†³éœ€æ±‚ï¼Œä»ç»“æœæ¨å¯¼è¿‡ç¨‹ï¼Œç„¶ååœ¨åˆé€‚çš„åœ°æ–¹è¿›è¡Œhookï¼Œå®ç°è‡ªå·±çš„éœ€æ±‚ã€‚
ç¨‹åºå‘˜ä»¬ï¼Œå¯ä»¥æ‹¿æ¥æµ‹ä¸€æµ‹è‡ªå·±çš„å¥³ç¥ã€‚ã€‚ã€‚

æœ€åç¥ç¨‹åºå‘˜ä»¬æƒ…äººèŠ‚å¿«ä¹ï¼





