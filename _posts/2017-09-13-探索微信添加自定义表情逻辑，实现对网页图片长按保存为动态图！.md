---
layout: post
title: 'æ¢ç´¢å¾®ä¿¡æ·»åŠ è‡ªå®šä¹‰è¡¨æƒ…é€»è¾‘ï¼Œå®ç°å¯¹ç½‘é¡µå›¾ç‰‡é•¿æŒ‰ä¿å­˜ä¸ºåŠ¨æ€å›¾ï¼'
date: 2017-09-13 16:29:57
tags: []
---

æ—¥å¸¸åœ¨å¾®ä¿¡è§‚çœ‹è®¢é˜…å·ï¼Œæ€»èƒ½å‘ç°ä¸€äº›å¾ˆæœ‰æ„æ€çš„GIFå›¾ï¼Œä¹ æƒ¯æ€§é•¿æŒ‰ä¿å­˜åˆ°è¡¨æƒ…,
æ— å¥ˆï¼Œå¾®ä¿¡å¹¶æ²¡æœ‰å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œåªèƒ½å…ˆä¿å­˜åˆ°ç›¸å†Œï¼Œå†æ·»åŠ ä¿å­˜åˆ°è¡¨æƒ…ä¸­ï¼Œåœ¨è¿™é‡Œï¼Œä¸»è¦æ˜¯æ¢ç´¢å¾®ä¿¡æ·»åŠ è¡¨æƒ…çš„é€»è¾‘
å½“ç„¶å®Œæˆçš„é¡¹ç›®ä»£ç è¿˜æ˜¯æœ‰çš„ï¼š[WeChatWebEmoticon](https://github.com/Mainstayz/WeChatWebEmoticon)


<!-- more -->


## æ€è·¯

æˆ‘ä»¬å›å¿†ä¸€ä¸‹ï¼Œå¾®ä¿¡æ·»åŠ è‡ªå®šä¹‰è¡¨æƒ…è¡¨æƒ…æœ‰ä»€ä¹ˆæ­¥éª¤ã€‚

```
1. ç‚¹å‡»èŠå¤©è¾“å…¥æ¡†å³è¾¹çš„ç¬‘è„¸
2. é€‰æ‹©çº¢å¿ƒï¼ˆâ™¥ï¸ï¼‰çš„è‡ªå®šä¹‰è¡¨æƒ…
3. ç‚¹å‡»åŠ å·itemï¼Œå¼¹å‡ºè¡¨æƒ…ç®¡ç†ç•Œé¢
4. ç‚¹å‡»æœ€ä¸‹é¢åŠ å·itemï¼Œå¼¹å‡ºç›¸å†Œ
5. é€‰ä¸­GIFå›¾æˆ–è€…å›¾ç‰‡ï¼Œå¼¹å‡ºå›¾ç‰‡é€‰æ‹©å™¨ï¼Œç‚¹å‡»å®ŒæˆæŒ‰é’®ï¼Œä¿å­˜åˆ°è¡¨æƒ…
```

å…³é”®ç‚¹ï¼š

```
1. äº†è§£æ­¥éª¤5ä¸­ç‚¹å‡»å®ŒæˆæŒ‰é’®çš„ä¸Šä¼ é€»è¾‘
2. æŠŠæˆ‘ä»¬éœ€è¦ä¿å­˜ä¸ºè¡¨æƒ…çš„å›¾ç‰‡ä¼ è¿›å»
```

## å¯»æ‰¾ä¸Šä¼ é€»è¾‘

### äº†è§£è¡¨æƒ…é€‰æ‹©å™¨ç‚¹å‡»å®ŒæˆæŒ‰é’®çš„åŠ¨ä½œ

åœ¨XcodeæŸ¥çœ‹è§†å›¾å±‚çº§
![](/images/1564382508708.jpg)
å¾—åˆ°å®ŒæˆæŒ‰é’®çš„åœ°å€ **0x11adbca90**

`<UIButton: 0x11adbca90; frame = (268 11; 42 42); opaque = NO; autoresize = LM; layer = <CALayer: 0x11ad684d0>>`

è·å–Buttonçš„action

```
(lldb) pactions 0x11adbca90
<MMImagePreviewBrowserController: 0x115f70400>: OnClickDoneBarButton

```

> æç¤ºï¼špactions è¿™ä¸ªå‘½ä»¤éœ€è¦å®‰è£… Chisel

æ‰“å¼€hopperï¼ŒæŸ¥çœ‹å®ç°ï¼š

```
void -[MMImagePreviewBrowserController OnClickDoneBarButton](void * self, void * _cmd) {
    [self OnSelectedButtonDone];
    loc_2d65a94(self, @selector(sendSelectedImage), r2);
    return;
}

```

ç»§ç»­é€šè¿‡hopperè¿›ä¸€æ­¥æ·±å…¥å»æŸ¥çœ‹..é™·å…¥ä¸€å›¢éº»ç»³ä¸­..æœ€ç»ˆ..å’... ğŸ˜¢ğŸ˜¢ğŸ˜¢

**ç»éªŒå‘Šè¯‰æˆ‘ï¼Œåœ¨é€†å‘å·¥ç¨‹ä¸­ï¼ŒæŒ‰ç…§æ­£å‘çš„å¼€å‘é€»è¾‘å»æ¢ç´¢å¾ˆç—›è‹¦ï¼Œå¾ˆéš¾ã€‚**

### æ¢ä¸ªæ€è·¯

MMImagePreviewBrowserController é¡¾åæ€ä¹‰æ˜¯å›¾ç‰‡é¢„è§ˆæ§åˆ¶å™¨ï¼ŒåŸºäºå•ä¸€èŒè´£åŸåˆ™ï¼Œåº”è¯¥ä¸ä¼šå®ç°è¡¨æƒ…çš„ä¸Šä¼ é€»è¾‘ã€‚

åŒæ ·å¯¹äº MMAssetPickerController å›¾ç‰‡é€‰æ‹©å™¨ä¹Ÿåº”è¯¥ä¸å­˜åœ¨ä¸Šä¼ é€»è¾‘ã€‚

é‚£ä¼šæ˜¯è°å‘¢ï¼Ÿ

![](/images/1564382564568.jpg)

**EmoticonCustomManageViewController** è‡ªå®šä¹‰è¡¨æƒ…ç®¡ç†æ§åˆ¶å™¨ï¼Œä»åå­—æ¥çœ‹ï¼Œæœ‰å¾ˆå¤§å¯èƒ½æ€§ã€‚

é›†æˆ ANYMethodLog å¯¹ **EmoticonCustomManageViewController** æ‰€æœ‰çš„æ–¹æ³•è¿›è¡Œhookï¼Œè¿½è¸ªä¸Šä¼ é€»è¾‘ï¼Œç‚¹å‡»å®ŒæˆæŒ‰é’®ï¼Œæœ‰ä»¥ä¸‹è¾“å‡ºï¼š

```
2017-09-12 18:06:03.109883+0800 WeChat[1562:544640] MMImagePickerManager:didFinishPickingImageWithInfo: (
    "<MMImagePickerController: 0x106cbf800>",
        (
                {
            MMImageDataPathURL = "/private/var/mobile/Containers/Data/Application/B74DAC50-F1AE-4B4B-A365-566F8D53DE18/tmp//MMImagePicker/Image/291505210763.jpeg";
            MMImageMMAssetIsGIF = 1;
            UIImagePickerControllerMediaType = ALAssetTypePhoto;
            UIImagePickerControllerOriginalImage = "<UIImage: 0x174a964e0>, {424, 246}";
        }
    )
)
2017-09-12 18:06:03.110196+0800 WeChat[1562:544640] handleGIFInfo: (
        {
        MMImageDataPathURL = "/private/var/mobile/Containers/Data/Application/B74DAC50-F1AE-4B4B-A365-566F8D53DE18/tmp//MMImagePicker/Image/291505210763.jpeg";
        MMImageMMAssetIsGIF = 1;
        UIImagePickerControllerMediaType = ALAssetTypePhoto;
        UIImagePickerControllerOriginalImage = "<UIImage: 0x174a964e0>, {424, 246}";
    }
)

```

ä¸¤ä¸ªæ–¹æ³•æµ®å‡ºæ°´é¢ã€‚

```
// ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼ŒçŒœæµ‹æ˜¯æ‰§è¡Œä»£ç†
-[EmoticonCustomManageViewController MMImagePickerManager:didFinishPickingImageWithInfo:] 

// ç¬¬äºŒä¸ªæ–¹æ³•ï¼Œå¤„ç†Gif
-[EmoticonCustomManageViewController handleGIFInfo:] 
```

ä»æ–¹æ³•åæ¥çŒœï¼Œæˆ–è®¸å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„æ–¹æ³•ã€‚

å…ˆçœ‹ç¬¬ä¸€ä¸ªï¼š

```
// æ‰‹åŠ¨æ•´ç†ä¼ªä»£ç 
-(void)MMImagePickerManager:(MMImagePickerController *)imagePickerController didFinishPickingImageWithInfo:(NSArray *)info{
	Bool isGIF = [[info firstObject][@"MMImageMMAssetIsGIF"] boolValue];
	
	if (isGIF) {
	// å¦‚æœæ˜¯åŠ¨æ€å›¾
		[self handleGIFInfo:[info firstObject]]; 
	}else{
	// å¦‚æœæ˜¯é™æ€å›¾ç‰‡
		[self DismissModalViewControllerAnimated:0x01];
		......
		......
		
		UIImage *image = [info firstObject][@"UIImagePickerControllerOriginalImage"];
		
		EmoticonPickViewController *pickViewController = [EmoticonPickViewController new];
		[pickViewController setM_image:image];
		[self.navigationController PushViewController:pickViewController animated:YES];
	}
	
}
```

å¯ä»¥çœ‹åˆ°å¦‚æœæ˜¯GIFå›¾ç›´æ¥å»è°ƒç”¨handleGIFInfoï¼šæ–¹æ³•ï¼Œå¦åˆ™å°±ä¼ å…¥åˆ°EmoticonPickViewControllerä¸­ã€‚

ç¬¬äºŒä¸ªæ–¹æ³•ï¼Œæ‰‹åŠ¨æ•´ç†å¾—ï¼š

```
-(void)handleGIFInfo:(NSDictionary*)dic{

	
 	 NSData *data = dic[@"MMImageDataObject"];
 	 if(data.length == 0){
 	 	data = [NSData dataWithContentsOfFile:dic[@"MMImageDataPathURL"]];
 	 }
 	 // è·å–MD5å€¼
 	 NSString *md5 = [CBaseFile GetDataMD5:data];
 	 // ä¿å­˜åˆ°è¡¨æƒ…ç›®å½•
 	 if([EmoticonUtil saveEmoticonToEmoticonDirForMd5:md5 data:data isCleanable:YES]){
 	 CEmoticonMgr*emoticonMgr =  [[MMServiceCenter defaultCenter] getService:[CEmoticonMgr class]];
 	 // æ ¹æ®MD5æ£€æŸ¥æœ¬åœ°è¡¨æƒ…æ˜¯å¦å­˜åœ¨
 	Bool exist = [emoticonMgr CheckEmoticonExistInCustomListByMd5:md5];
 	// å¦‚æœå­˜åœ¨
	 	if (exist){
 			// å¼¹å‡ºAlert 
 			......
 			[self DismissModalViewControllerAnimated:YES];
 		}else{
 	
	 		// åŒ…è£…è¡¨æƒ…
 			AddEmoticonWrap *wrap = [[AddEmoticonWrap alloc] init];
 			[wrap setSource:YES];
 			// è®¾ç½®è¡¨æƒ…çš„MD5
 			[wrap setMd5:md5];
 		
 			// åå°ä¼šæ ¹æ®md5å»æŸ¥è¯¢æœ¬åœ°è¡¨æƒ…ï¼Œä¸Šä¼ åŒæ­¥åˆ°æœåŠ¡å™¨
 			[self.addEmoticonLogic startAddEmoticonWithWrap:wrap];
 		......
 			// æ˜¾ç¤ºloadingView
 			[self DismissModalViewControllerAnimated:YES];
 		}
	 }else{
		 // é”™è¯¯å¤„ç†.....
		 [self DismissModalViewControllerAnimated:YES];
	 }
   return;	
}

```

è‡³æ­¤ï¼Œå¾®ä¿¡å›¾ç‰‡ä¸Šä¼ é€»è¾‘å·²ç»ç†æ¸…

## ç»“è¯­

åœ¨è¿™é‡Œä¸»è¦æ˜¯åˆ†äº«ä¸€ä¸‹æ¢ç´¢å¾®ä¿¡æ·»åŠ è¡¨æƒ…çš„é€»è¾‘ï¼Œå‰©ä¸‹çš„é•¿æŒ‰å›¾ç‰‡ä¿å­˜ä¸ºè¡¨æƒ…å°±ç®€å•äº†ï¼Œæ— éå°±æ˜¯æ ¹æ®å›¾ç‰‡URLè·å–dataï¼Œåˆ¤æ–­æ˜¯éæ˜¯GIFå›¾ï¼Œå¥—ç”¨ä¸Šä¼ é€»è¾‘ã€‚

æƒ³äº†è§£è¯¦æƒ…çš„ï¼Œå¯ä»¥å»æˆ‘çš„é¡¹ç›®åœ°å€ä¸­çœ‹çœ‹è¯¦ç»†ä»£ç ã€‚

